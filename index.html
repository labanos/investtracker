<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portfolio</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Portfolio">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; -webkit-tap-highlight-color: transparent; }
    .mono { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useCallback } = React;

// ─── Portfolio data ────────────────────────────────────────────────────────
// yhTicker = Yahoo Finance symbol | cachedPrice/cachedChangePct = fallback from last sync
const PORTFOLIO = [
  { ticker:'RGTI',     yhTicker:'RGTI',       company:'Rigetti Computing',       ccy:'USD', shares:100,  avgCost:9.91,      cachedPrice:18.82,   cachedChg:0.0675  },
  { ticker:'LULU',     yhTicker:'LULU',       company:'Lululemon Athletica',      ccy:'USD', shares:53,   avgCost:164.97,    cachedPrice:187.38,  cachedChg:0.0265  },
  { ticker:'NOVO-B',   yhTicker:'NOVO-B.CO',  company:'Novo Nordisk',             ccy:'DKK', shares:475,  avgCost:364.3228,  cachedPrice:239.0,   cachedChg:0.0038  },
  { ticker:'ROCK-B',   yhTicker:'ROCK-B.CO',  company:'ROCKWOOL Class B',         ccy:'DKK', shares:375,  avgCost:173.5783,  cachedPrice:210.5,   cachedChg:-0.0071 },
  { ticker:'JYSK',     yhTicker:'JYSK.CO',    company:'Jyske Bank',               ccy:'DKK', shares:2367, avgCost:356.1019,  cachedPrice:948.0,   cachedChg:-0.0037 },
  { ticker:'NFLX',     yhTicker:'NFLX',       company:'Netflix',                  ccy:'USD', shares:120,  avgCost:27.697,    cachedPrice:84.17,   cachedChg:0.0189  },
  { ticker:'CSU',      yhTicker:'CSU.TO',     company:'Constellation Software',   ccy:'CAD', shares:8,    avgCost:3161.3675, cachedPrice:2520.0,  cachedChg:0.0246  },
  { ticker:'CHG',      yhTicker:'CHG.DE',     company:'CHAPTERS Group',           ccy:'EUR', shares:400,  avgCost:34.05,     cachedPrice:26.7,    cachedChg:-0.0220 },
  { ticker:'AAPL',     yhTicker:'AAPL',       company:'Apple',                    ccy:'USD', shares:75,   avgCost:137.51,    cachedPrice:273.63,  cachedChg:-0.0015 },
  { ticker:'GMAB',     yhTicker:'GMAB.CO',    company:'Genmab',                   ccy:'DKK', shares:40,   avgCost:1382.6,    cachedPrice:1831.5,  cachedChg:-0.0008 },
  { ticker:'DANSKE',   yhTicker:'DANSKE.CO',  company:'Danske Bank',              ccy:'DKK', shares:710,  avgCost:114.7752,  cachedPrice:333.0,   cachedChg:-0.0063 },
  { ticker:'ASML',     yhTicker:'ASML.AS',    company:'ASML Holding',             ccy:'EUR', shares:20,   avgCost:696.605,   cachedPrice:1250.6,  cachedChg:-0.0217 },
  { ticker:'NVDA',     yhTicker:'NVDA',       company:'NVIDIA',                   ccy:'USD', shares:104,  avgCost:119.2683,  cachedPrice:188.51,  cachedChg:-0.0318 },
  { ticker:'IONQ',     yhTicker:'IONQ',       company:'IonQ',                     ccy:'USD', shares:25,   avgCost:36.88,     cachedPrice:40.76,   cachedChg:0.2186  },
  { ticker:'MSFT',     yhTicker:'MSFT',       company:'Microsoft',                ccy:'USD', shares:25,   avgCost:404.078,   cachedPrice:405.37,  cachedChg:0.0138  },
  { ticker:'V',        yhTicker:'V',          company:'Visa',                     ccy:'USD', shares:20,   avgCost:229.78,    cachedPrice:319.19,  cachedChg:0.0195  },
  { ticker:'NU',       yhTicker:'NU',         company:'Nu Holdings',              ccy:'USD', shares:800,  avgCost:12.4489,   cachedPrice:15.64,   cachedChg:-0.0541 },
  { ticker:'BKNG',     yhTicker:'BKNG',       company:'Booking Holdings',         ccy:'USD', shares:2,    avgCost:5119.75,   cachedPrice:4251.93, cachedChg:0.0214  },
  { ticker:'MLI',      yhTicker:'MLI',        company:'Mueller Industries',       ccy:'USD', shares:210,  avgCost:46.1674,   cachedPrice:118.27,  cachedChg:-0.0027 },
  { ticker:'GOOGL',    yhTicker:'GOOGL',      company:'Alphabet',                 ccy:'USD', shares:120,  avgCost:95.04,     cachedPrice:305.68,  cachedChg:-0.0231 },
  { ticker:'SNPS',     yhTicker:'SNPS',       company:'Synopsys',                 ccy:'USD', shares:40,   avgCost:437.237,   cachedPrice:432.52,  cachedChg:-0.0371 },
  { ticker:'TSM',      yhTicker:'TSM',        company:'Taiwan Semiconductor',     ccy:'USD', shares:100,  avgCost:79.055,    cachedPrice:375.45,  cachedChg:-0.0282 },
  { ticker:'ADBE',     yhTicker:'ADBE',       company:'Adobe',                    ccy:'USD', shares:26,   avgCost:335.74,    cachedPrice:262.32,  cachedChg:0.0121  },
  { ticker:'QUBT',     yhTicker:'QUBT',       company:'Quantum Computing',        ccy:'USD', shares:100,  avgCost:10.31,     cachedPrice:8.95,    cachedChg:0.0346  },
  { ticker:'MAERSK-B', yhTicker:'MAERSK-B.CO',company:'A.P. Møller-Mærsk',       ccy:'DKK', shares:15,   avgCost:11705.7333,cachedPrice:15200.0, cachedChg:-0.0095 },
  { ticker:'NET',      yhTicker:'NET',        company:'Cloudflare',               ccy:'USD', shares:30,   avgCost:170.0,     cachedPrice:174.61,  cachedChg:0.0176  },
  { ticker:'QBTS',     yhTicker:'QBTS',       company:'D-Wave Quantum',           ccy:'USD', shares:200,  avgCost:5.51,      cachedPrice:20.93,   cachedChg:0.0651  },
];

// ─── Transactions ──────────────────────────────────────────────────────────
// Each entry: { date:'YYYY-MM-DD', type:'buy'|'sell', shares, price, fees, note }
const TRANSACTIONS = {
  'RGTI': [
    { date:'2025-01-14', type:'buy', shares:100, price:9.91, fees:0 },
  ],
  'LULU': [
    { date:'2025-11-02', type:'buy', shares:53, price:164.97, fees:0 },
  ],
  'NOVO-B': [
    { date:'2022-12-29', type:'buy', shares:300, price:341.62, fees:0 },
    { date:'2025-01-06', type:'buy', shares:35, price:604.3, fees:0 },
    { date:'2025-04-29', type:'buy', shares:65, price:424.9, fees:0 },
    { date:'2025-05-05', type:'buy', shares:176, price:455.45, fees:0 },
    { date:'2025-05-08', type:'buy', shares:3, price:445.7, fees:0 },
    { date:'2025-07-28', type:'buy', shares:77, price:356.6, fees:0 },
    { date:'2025-07-30', type:'buy', shares:2, price:321.15, fees:0 },
    { date:'2025-11-26', type:'sell', shares:65, price:310.65, fees:0 },
    { date:'2025-11-26', type:'sell', shares:300, price:310.65, fees:0 },
    { date:'2025-11-26', type:'sell', shares:35, price:310.65, fees:0 },
    { date:'2026-01-06', type:'buy', shares:17, price:359.45, fees:0 },
    { date:'2026-02-22', type:'buy', shares:200, price:259.1, fees:0 },
  ],
  'ROCK-B': [
    { date:'2025-04-08', type:'buy', shares:370, price:172.73, fees:0 },
    { date:'2025-08-20', type:'buy', shares:4, price:238.9, fees:0 },
    { date:'2026-02-15', type:'buy', shares:1, price:226.15, fees:0 },
  ],
  'JYSK': [
    { date:'2022-12-29', type:'buy', shares:2018, price:278.95, fees:0 },
    { date:'2022-12-29', type:'buy', shares:133, price:171.2, fees:0 },
    { date:'2023-01-19', type:'buy', shares:25, price:481.09, fees:0 },
    { date:'2023-02-08', type:'buy', shares:24, price:517.17, fees:0 },
    { date:'2023-03-15', type:'buy', shares:25, price:478.66, fees:0 },
    { date:'2023-04-18', type:'buy', shares:24, price:517.9, fees:0 },
    { date:'2023-05-21', type:'buy', shares:26, price:479.4, fees:0 },
    { date:'2023-06-07', type:'buy', shares:23, price:522.95, fees:0 },
    { date:'2023-07-03', type:'buy', shares:24, price:521.65, fees:0 },
    { date:'2023-08-23', type:'buy', shares:25, price:486.2, fees:0 },
    { date:'2023-09-06', type:'buy', shares:25, price:492.05, fees:0 },
    { date:'2023-10-04', type:'buy', shares:25, price:488.44, fees:0 },
    { date:'2023-11-09', type:'buy', shares:26, price:474.62, fees:0 },
    { date:'2023-12-05', type:'buy', shares:25, price:476.94, fees:0 },
    { date:'2024-01-09', type:'buy', shares:27, price:504.69, fees:0 },
    { date:'2024-01-11', type:'sell', shares:184, price:543, fees:0 },
    { date:'2024-02-07', type:'buy', shares:25, price:524.58, fees:0 },
    { date:'2024-03-19', type:'buy', shares:24, price:569.26, fees:0 },
    { date:'2024-04-15', type:'buy', shares:24, price:565.98, fees:0 },
    { date:'2024-05-22', type:'buy', shares:26, price:541.88, fees:0 },
    { date:'2024-06-26', type:'buy', shares:24, price:564.78, fees:0 },
    { date:'2024-07-03', type:'buy', shares:25, price:549.4, fees:0 },
    { date:'2024-08-26', type:'buy', shares:25, price:538.85, fees:0 },
    { date:'2024-09-09', type:'buy', shares:26, price:528.07, fees:0 },
    { date:'2024-10-08', type:'buy', shares:26, price:521.73, fees:0 },
    { date:'2024-11-06', type:'buy', shares:27, price:495.75, fees:0 },
    { date:'2024-12-17', type:'buy', shares:27, price:503.13, fees:0 },
    { date:'2025-01-02', type:'sell', shares:200, price:512, fees:0 },
    { date:'2025-01-09', type:'sell', shares:100, price:506.5, fees:0 },
    { date:'2025-01-15', type:'buy', shares:26, price:530.78, fees:0 },
    { date:'2025-02-04', type:'buy', shares:27, price:515.97, fees:0 },
    { date:'2025-03-18', type:'buy', shares:23, price:590.29, fees:0 },
    { date:'2025-04-09', type:'buy', shares:30, price:470.1, fees:0 },
    { date:'2025-05-25', type:'buy', shares:22, price:623.88, fees:0 },
    { date:'2025-06-16', type:'buy', shares:22, price:636.03, fees:0 },
    { date:'2025-07-01', type:'buy', shares:22, price:638.44, fees:0 },
    { date:'2025-08-25', type:'buy', shares:20, price:710.57, fees:0 },
    { date:'2025-09-23', type:'buy', shares:19, price:705, fees:0 },
    { date:'2025-10-01', type:'buy', shares:20, price:710.49, fees:0 },
    { date:'2025-11-11', type:'buy', shares:18, price:777.74, fees:0 },
    { date:'2025-12-16', type:'buy', shares:17, price:837, fees:0 },
    { date:'2026-01-12', type:'sell', shares:100, price:882.5, fees:0 },
    { date:'2026-01-12', type:'buy', shares:16, price:883.5, fees:0 },
    { date:'2026-02-17', type:'buy', shares:15, price:938.85, fees:0 },
    { date:'2026-02-22', type:'sell', shares:100, price:961, fees:0 },
  ],
  'NFLX': [
    { date:'2022-12-28', type:'buy', shares:120, price:27.7, fees:0 },
  ],
  'CSU': [
    { date:'2025-09-30', type:'buy', shares:2, price:3968.93, fees:0 },
    { date:'2025-11-30', type:'buy', shares:3, price:3309.73, fees:0 },
    { date:'2026-02-01', type:'buy', shares:3, price:2474.63, fees:0 },
  ],
  'CHG': [
    { date:'2025-12-29', type:'buy', shares:100, price:41.2, fees:0 },
    { date:'2026-01-13', type:'buy', shares:100, price:40.5, fees:0 },
    { date:'2026-02-22', type:'buy', shares:200, price:27.25, fees:0 },
  ],
  'AAPL': [
    { date:'2023-01-17', type:'buy', shares:75, price:137.51, fees:0 },
  ],
  'GMAB': [
    { date:'2025-06-23', type:'buy', shares:22, price:1352, fees:0 },
    { date:'2025-08-07', type:'buy', shares:18, price:1420, fees:0 },
  ],
  'DANSKE': [
    { date:'2022-12-29', type:'buy', shares:336, price:135.23, fees:0 },
    { date:'2022-12-29', type:'buy', shares:710, price:105.03, fees:0 },
    { date:'2023-07-25', type:'buy', shares:1, price:161.1, fees:0 },
    { date:'2025-05-05', type:'sell', shares:336, price:242.1, fees:0 },
    { date:'2025-05-05', type:'sell', shares:1, price:242.1, fees:0 },
  ],
  'ASML': [
    { date:'2025-01-09', type:'buy', shares:10, price:732.5, fees:0 },
    { date:'2025-07-15', type:'buy', shares:10, price:660.71, fees:0 },
  ],
  'NVDA': [
    { date:'2024-08-06', type:'buy', shares:50, price:100.01, fees:0 },
    { date:'2025-05-27', type:'buy', shares:54, price:137.1, fees:0 },
  ],
  'IONQ': [
    { date:'2025-01-14', type:'buy', shares:25, price:36.88, fees:0 },
  ],
  'MSFT': [
    { date:'2024-03-04', type:'buy', shares:20, price:405.39, fees:0 },
    { date:'2025-02-25', type:'buy', shares:5, price:398.83, fees:0 },
  ],
  'V': [
    { date:'2023-01-30', type:'buy', shares:20, price:229.78, fees:0 },
  ],
  'NU': [
    { date:'2024-11-25', type:'buy', shares:300, price:13.98, fees:0 },
    { date:'2024-11-28', type:'buy', shares:150, price:12.42, fees:0 },
    { date:'2025-02-23', type:'buy', shares:350, price:11.15, fees:0 },
  ],
  'BKNG': [
    { date:'2025-02-25', type:'buy', shares:2, price:5119.75, fees:0 },
  ],
  'MLI': [
    { date:'2023-12-21', type:'buy', shares:100, price:47.16, fees:0 },
    { date:'2024-01-15', type:'buy', shares:110, price:45.27, fees:0 },
  ],
  'GOOGL': [
    { date:'2023-02-12', type:'buy', shares:181, price:95.04, fees:0 },
    { date:'2025-09-29', type:'sell', shares:31, price:241.39, fees:0 },
    { date:'2025-11-02', type:'sell', shares:30, price:282.54, fees:0 },
  ],
  'SNPS': [
    { date:'2025-10-15', type:'buy', shares:22, price:438.74, fees:0 },
    { date:'2025-11-30', type:'buy', shares:18, price:435.4, fees:0 },
  ],
  'TSM': [
    { date:'2023-01-05', type:'buy', shares:50, price:77.82, fees:0 },
    { date:'2023-01-08', type:'buy', shares:50, price:80.29, fees:0 },
  ],
  'ADBE': [
    { date:'2025-08-10', type:'buy', shares:26, price:335.74, fees:0 },
  ],
  'QUBT': [
    { date:'2025-01-14', type:'buy', shares:100, price:10.31, fees:0 },
  ],
  'MAERSK-B': [
    { date:'2023-01-10', type:'buy', shares:4, price:14580, fees:0 },
    { date:'2023-01-19', type:'buy', shares:2, price:14805, fees:0 },
    { date:'2024-03-03', type:'buy', shares:7, price:9548, fees:0 },
    { date:'2025-04-02', type:'buy', shares:2, price:10410, fees:0 },
  ],
  'NET': [
    { date:'2026-01-20', type:'buy', shares:30, price:170, fees:0 },
  ],
  'QBTS': [
    { date:'2025-01-14', type:'buy', shares:200, price:5.51, fees:0 },
  ],
};

// ─── Notes & Diary ─────────────────────────────────────────────────────────
// Each entry: { date:'YYYY-MM-DD', text }
const NOTES = {
  'RGTI':      [],
  'LULU':      [],
  'NOVO-B':    [],
  'ROCK-B':    [],
  'JYSK':      [],
  'NFLX':      [],
  'CSU':       [],
  'CHG':       [],
  'AAPL':      [],
  'GMAB':      [],
  'DANSKE':    [],
  'ASML':      [],
  'NVDA':      [],
  'IONQ':      [],
  'MSFT':      [],
  'V':         [],
  'NU':        [],
  'BKNG':      [],
  'MLI':       [],
  'GOOGL':     [],
  'SNPS':      [],
  'TSM':       [],
  'ADBE':      [],
  'QUBT':      [],
  'MAERSK-B':  [],
  'NET':       [],
  'QBTS':      [],
};

const CACHED_FX = { USD: 6.32546, EUR: 7.471825, CAD: 4.6206, DKK: 1.0 };
// ↑ Update CACHED_AS_OF whenever you refresh the cached prices/FX above
const CACHED_AS_OF = new Date('2026-02-26T17:00:00');

// ─── Formatters ────────────────────────────────────────────────────────────
const n = (v, d=0) => isNaN(v)||v==null ? '–' : Math.abs(v).toLocaleString('da-DK', {minimumFractionDigits:d, maximumFractionDigits:d});
const pct = (v) => v==null||isNaN(v) ? '–' : (v>=0?'+':'−') + n(Math.abs(v*100),2) + '%';
const signed = (v, d=0) => v==null||isNaN(v) ? '–' : (v>=0?'+':'−') + n(Math.abs(v),d);
const clr = (v) => !v && v!==0 ? 'text-gray-400' : v > 0 ? 'text-emerald-500' : v < 0 ? 'text-red-500' : 'text-gray-400';

// ─── Detail Page ───────────────────────────────────────────────────────────
function DetailPage({ position: p, onBack, isLive, lastUpdated }) {
  const txns  = (TRANSACTIONS[p.ticker] || []).slice().sort((a,b) => b.date.localeCompare(a.date));
  const notes = (NOTES[p.ticker] || []).slice().sort((a,b) => b.date.localeCompare(a.date));

  const totalBought = txns.filter(t=>t.type==='buy').reduce((s,t)=>s+(t.shares*t.price+t.fees),0);
  const totalSold   = txns.filter(t=>t.type==='sell').reduce((s,t)=>s+(t.shares*t.price-t.fees),0);

  const fmtDate = (d) => {
    const [y,m,day] = d.split('-');
    return `${day}.${m}.${y}`;
  };

  const typeTag = (type) => type === 'buy'
    ? <span className="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-emerald-100 text-emerald-700">BUY</span>
    : <span className="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-red-100 text-red-600">SELL</span>;

  return (
    <div className="min-h-screen bg-gray-50 pb-12">

      {/* ── Header ── */}
      <div className="bg-gray-900 text-white px-4 py-3 flex items-center gap-3 sticky top-0 z-20">
        <button onClick={onBack} className="text-gray-400 hover:text-white transition-colors text-sm flex items-center gap-1">
          ← Portfolio
        </button>
        <div className="flex-1 flex items-center gap-2 min-w-0">
          <span className="font-bold text-lg">{p.ticker}</span>
          <span className="text-gray-400 text-sm truncate">{p.company}</span>
        </div>
        <span className={`text-[11px] px-2 py-0.5 rounded-full ${isLive ? 'bg-emerald-500 text-white' : 'bg-gray-600 text-gray-300'}`}>
          {isLive ? 'live' : 'cached'}
        </span>
      </div>

      {/* ── Stats row ── */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4">
        {[
          { label: 'Price', value: p.price >= 1000 ? n(p.price,0) : n(p.price,2), sub: p.ccy },
          { label: 'Today', value: pct(p.chgPct), sub: signed(p.todayDKK,0)+' DKK', color: clr(p.chgPct) },
          { label: 'Total G/L', value: pct(p.glPct), sub: signed(p.glDKK,0)+' DKK', color: clr(p.glPct) },
          { label: 'Position', value: p.shares+' shares', sub: 'avg '+n(p.avgCost,2)+' '+p.ccy },
        ].map(({ label, value, sub, color }) => (
          <div key={label} className="bg-white rounded-xl px-4 py-3 shadow-sm border border-gray-100">
            <div className="text-[11px] text-gray-400 mb-1">{label}</div>
            <div className={`font-semibold text-[16px] mono ${color||'text-gray-900'}`}>{value}</div>
            <div className={`text-[11px] mono mt-0.5 ${color||'text-gray-400'}`}>{sub}</div>
          </div>
        ))}
      </div>

      {/* ── Transactions ── */}
      <div className="mx-4 mb-6">
        <h2 className="text-[13px] font-semibold text-gray-600 uppercase tracking-wide mb-2">Transactions</h2>
        {txns.length === 0 ? (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-6 text-center text-gray-400 text-sm">
            No transactions yet — add them to the <code className="bg-gray-100 px-1 rounded">TRANSACTIONS</code> object in the source file.
          </div>
        ) : (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
            <table className="w-full text-[12px]">
              <thead>
                <tr className="border-b border-gray-100 text-gray-400 text-[11px] uppercase tracking-wide">
                  <th className="px-3 py-2 text-left">Date</th>
                  <th className="px-3 py-2 text-left">Type</th>
                  <th className="px-3 py-2 text-right">Shares</th>
                  <th className="px-3 py-2 text-right">Price</th>
                  <th className="px-3 py-2 text-right">Fees</th>
                  <th className="px-3 py-2 text-right">Value</th>
                  <th className="px-3 py-2 text-left">Note</th>
                </tr>
              </thead>
              <tbody>
                {txns.map((t, i) => (
                  <tr key={i} className={`border-b border-gray-50 ${i%2===0?'bg-white':'bg-gray-50/40'}`}>
                    <td className="px-3 py-2 mono text-gray-500">{fmtDate(t.date)}</td>
                    <td className="px-3 py-2">{typeTag(t.type)}</td>
                    <td className="px-3 py-2 text-right mono text-gray-700">{n(t.shares,0)}</td>
                    <td className="px-3 py-2 text-right mono text-gray-700">{n(t.price,2)}</td>
                    <td className="px-3 py-2 text-right mono text-gray-400">{t.fees ? n(t.fees,2) : '–'}</td>
                    <td className={`px-3 py-2 text-right mono font-medium ${t.type==='buy'?'text-gray-700':'text-emerald-600'}`}>
                      {t.type==='buy' ? '−'+n(t.shares*t.price+(t.fees||0),0) : '+'+n(t.shares*t.price-(t.fees||0),0)}
                    </td>
                    <td className="px-3 py-2 text-gray-500 max-w-[180px] truncate">{t.note||''}</td>
                  </tr>
                ))}
              </tbody>
              {txns.length > 1 && (
                <tfoot className="border-t border-gray-200 bg-gray-50 text-[11px] text-gray-500">
                  <tr>
                    <td colSpan={5} className="px-3 py-2">Total invested / received</td>
                    <td className="px-3 py-2 text-right mono font-semibold text-gray-700">
                      {totalBought > 0 && <span className="text-gray-700">−{n(totalBought,0)}</span>}
                      {totalSold > 0 && <span className="text-emerald-600 ml-2">+{n(totalSold,0)}</span>}
                    </td>
                    <td />
                  </tr>
                </tfoot>
              )}
            </table>
          </div>
        )}
      </div>

      {/* ── Notes & Diary ── */}
      <div className="mx-4">
        <h2 className="text-[13px] font-semibold text-gray-600 uppercase tracking-wide mb-2">Notes & Diary</h2>
        {notes.length === 0 ? (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-6 text-center text-gray-400 text-sm">
            No notes yet — add them to the <code className="bg-gray-100 px-1 rounded">NOTES</code> object in the source file.
          </div>
        ) : (
          <div className="flex flex-col gap-2">
            {notes.map((note, i) => (
              <div key={i} className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-3">
                <div className="text-[11px] text-gray-400 mono mb-1">{fmtDate(note.date)}</div>
                <p className="text-[13px] text-gray-700 leading-relaxed whitespace-pre-wrap">{note.text}</p>
              </div>
            ))}
          </div>
        )}
      </div>

    </div>
  );
}

// ─── App ───────────────────────────────────────────────────────────────────
function App() {
  const [prices, setPrices]       = useState({});
  const [fx, setFx]               = useState(CACHED_FX);
  const [loading, setLoading]     = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [isLive, setIsLive]       = useState(false);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [sortBy, setSortBy]       = useState('value');
  const [sortDir, setSortDir]     = useState('desc');
  const [notice, setNotice]       = useState(null);
  const [selectedTicker, setSelectedTicker] = useState(null);

  const fetchPrices = useCallback(async (silent=false) => {
    if (!silent) setLoading(true);
    setRefreshing(true);

    const stockSyms = PORTFOLIO.map(p => p.yhTicker);
    const fxSyms    = ['USDDKK=X','EURDKK=X','CADDKK=X'];
    const symbols   = [...stockSyms, ...fxSyms].join(',');
    const workerUrl = `https://yf-proxy.labanos.workers.dev/?symbols=${symbols}`;
    const apiUrl    = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${symbols}&fields=regularMarketPrice,regularMarketChangePercent`;

    // Try worker first (Cloudflare proxy bypasses CORS/auth), then fall back
    const sources = [
      workerUrl,                                                                  // Cloudflare Worker (primary)
      apiUrl,                                                                     // direct (works in some browsers)
      `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`,                     // proxy 1
    ];

    let rows = null;
    for (const url of sources) {
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 8000);
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeout);
        if (!res.ok) continue;
        const json = await res.json();
        const result = json?.quoteResponse?.result || [];
        if (result.length > 0) { rows = result; break; }
      } catch (e) { continue; }
    }

    if (rows) {
      const newPrices = {};
      const newFx = { ...CACHED_FX };
      rows.forEach(q => {
        const price  = q.regularMarketPrice;
        const chgPct = (q.regularMarketChangePercent ?? 0) / 100;
        if      (q.symbol === 'USDDKK=X') newFx.USD = price;
        else if (q.symbol === 'EURDKK=X') newFx.EUR = price;
        else if (q.symbol === 'CADDKK=X') newFx.CAD = price;
        else newPrices[q.symbol] = { price, chgPct };
      });
      setPrices(newPrices);
      setFx(newFx);
      setIsLive(true);
      setLastUpdated(new Date());           // actual time of successful fetch
    } else {
      setIsLive(false);
      setLastUpdated(CACHED_AS_OF);         // time the cached prices were recorded
      if (Object.keys(prices).length === 0) {
        const cached = {};
        PORTFOLIO.forEach(p => { cached[p.yhTicker] = { price: p.cachedPrice, chgPct: p.cachedChg }; });
        setPrices(cached);
        setFx(CACHED_FX);
      }
    }
    setLoading(false);
    setRefreshing(false);
  }, []);

  useEffect(() => {
    fetchPrices();
    const iv = setInterval(() => fetchPrices(true), 5 * 60 * 1000);
    return () => clearInterval(iv);
  }, []);

  // Enrich each position
  const enriched = PORTFOLIO.map(p => {
    const pd = prices[p.yhTicker] || { price: p.cachedPrice, chgPct: p.cachedChg };
    const fxRate       = fx[p.ccy] || 1;
    const costDKK      = p.shares * p.avgCost * fxRate;
    const valueDKK     = p.shares * pd.price * fxRate;
    const glDKK        = valueDKK - costDKK;
    const glPct        = costDKK > 0 ? glDKK / costDKK : 0;
    // today's change: exact calc via prev price
    const prevPrice    = pd.chgPct !== -1 ? pd.price / (1 + pd.chgPct) : pd.price;
    const todayDKK     = p.shares * (pd.price - prevPrice) * fxRate;
    return { ...p, price: pd.price, chgPct: pd.chgPct, fxRate, costDKK, valueDKK, glDKK, glPct, todayDKK };
  });

  const totalValue  = enriched.reduce((s,p) => s + p.valueDKK, 0);
  const totalCost   = enriched.reduce((s,p) => s + p.costDKK, 0);
  const totalGL     = totalValue - totalCost;
  const totalGLPct  = totalCost > 0 ? totalGL / totalCost : 0;
  const todayTotal  = enriched.reduce((s,p) => s + p.todayDKK, 0);
  const prevTotal   = totalValue - todayTotal;
  const todayPct    = prevTotal > 0 ? todayTotal / prevTotal : 0;

  const withWeight = enriched.map(p => ({ ...p, weight: totalValue > 0 ? p.valueDKK / totalValue : 0 }));

  // ── Detail page navigation ──
  if (selectedTicker) {
    const pos = withWeight.find(p => p.ticker === selectedTicker);
    if (pos) return <DetailPage position={pos} onBack={() => setSelectedTicker(null)} isLive={isLive} lastUpdated={lastUpdated} />;
  }

  const sorted = [...withWeight].sort((a,b) => {
    let diff = 0;
    if (sortBy === 'value') diff = b.valueDKK - a.valueDKK;
    if (sortBy === 'today') diff = b.chgPct - a.chgPct;
    if (sortBy === 'gl')    diff = b.glPct - a.glPct;
    return sortDir === 'asc' ? -diff : diff;
  });

  const handleSort = (col) => {
    if (col === sortBy) {
      setSortDir(d => d === 'desc' ? 'asc' : 'desc');
    } else {
      setSortBy(col);
      setSortDir('desc');
    }
  };

  const SortBtn = ({ col, label }) => (
    <th
      className={`px-3 py-2 text-right cursor-pointer select-none text-xs ${sortBy===col ? 'text-gray-700 font-semibold' : 'text-gray-400 font-normal'}`}
      onClick={() => handleSort(col)}
    >
      {label}{sortBy===col ? (sortDir === 'desc' ? ' ↓' : ' ↑') : ''}
    </th>
  );

  const priceStr = (p) => {
    const v = p.price;
    if (v == null) return '–';
    if (v >= 1000) return v.toLocaleString('da-DK', {maximumFractionDigits:0});
    if (v >= 10)   return v.toLocaleString('da-DK', {minimumFractionDigits:2, maximumFractionDigits:2});
    return v.toLocaleString('da-DK', {minimumFractionDigits:2, maximumFractionDigits:2});
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-10">

      {/* ── Header ── */}
      <div className="bg-gray-900 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-20">
        <div className="flex items-center gap-2">
          <span className="font-semibold text-[15px]">Portfolio</span>
          <span className={`text-[10px] px-1.5 py-0.5 rounded-full font-medium ${isLive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-gray-700 text-gray-400'}`}>
            {isLive ? '● live' : '○ cached'}
          </span>
        </div>
        <div className="flex items-center gap-3">
          <button
            onClick={() => fetchPrices()}
            className="text-xs bg-gray-700 hover:bg-gray-600 active:bg-gray-500 transition-colors px-3 py-1.5 rounded-full"
          >
            {refreshing ? <span className="inline-block spin">↻</span> : '↻'}
          </button>
        </div>
      </div>

      {/* ── Price timestamp bar ── */}
      {lastUpdated && (
        <div className={`px-4 py-1.5 flex items-center justify-between text-[11px] border-b ${isLive ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-amber-50 border-amber-200 text-amber-700'}`}>
          <span>
            {isLive ? '● Prices as of' : '⚠ Cached prices from'}{' '}
            <span className="font-semibold mono">
              {lastUpdated.toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
            </span>
            {' '}
            <span className="opacity-70">
              {lastUpdated.toLocaleDateString('da-DK', {day:'2-digit', month:'2-digit', year:'numeric'})}
            </span>
          </span>
          {!isLive && <span className="font-medium">Live data unavailable</span>}
        </div>
      )}

      {loading ? (
        <div className="flex flex-col items-center justify-center h-64 gap-2 text-gray-400">
          <span className="text-2xl spin">↻</span>
          <span className="text-sm">Fetching prices…</span>
        </div>
      ) : (
        <>
          {/* ── Summary row ── */}
          <div className="grid grid-cols-3 bg-white border-b border-gray-100">
            <div className="px-4 py-3 border-r border-gray-100">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Portfolio</div>
              <div className="font-bold text-gray-900 mono text-base leading-tight">
                {n(totalValue, 0)}<span className="text-xs font-normal text-gray-400"> DKK</span>
              </div>
            </div>
            <div className="px-4 py-3 border-r border-gray-100">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Today</div>
              <div className={`font-bold mono text-base leading-tight ${clr(todayTotal)}`}>{pct(todayPct)}</div>
              <div className={`text-[11px] mono ${clr(todayTotal)}`}>{signed(todayTotal,0)} DKK</div>
            </div>
            <div className="px-4 py-3">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Total G/L</div>
              <div className={`font-bold mono text-base leading-tight ${clr(totalGL)}`}>{pct(totalGLPct)}</div>
              <div className={`text-[11px] mono ${clr(totalGL)}`}>{signed(totalGL,0)} DKK</div>
            </div>
          </div>

          {/* ── Table ── */}
          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-100 border-b border-gray-200">
                  <th className="px-4 py-2 text-left text-xs text-gray-400 font-normal">Stock</th>
                  <SortBtn col="value" label="Value" />
                  <SortBtn col="today" label="Today" />
                  <SortBtn col="gl"    label="G/L" />
                  <th className="px-3 py-2 text-right text-xs text-gray-400 font-normal">Wt</th>
                </tr>
              </thead>
              <tbody>
                {sorted.map((p, i) => (
                  <tr key={p.ticker} onClick={() => setSelectedTicker(p.ticker)} className={`border-b border-gray-100 cursor-pointer transition-colors ${i%2===0 ? 'bg-white hover:bg-blue-50' : 'bg-gray-50/60 hover:bg-blue-50'}`}>
                    <td className="px-4 py-2.5 min-w-[110px]">
                      <div className="font-semibold text-gray-900 text-[13px]">{p.ticker}</div>
                      <div className="text-[11px] text-gray-400 truncate max-w-[110px]">{p.company}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right">
                      <div className="font-medium text-gray-800 mono text-[13px]">{n(p.valueDKK,0)}</div>
                      <div className="text-[11px] text-gray-400 mono">{priceStr(p)} <span className="text-[10px]">{p.ccy}</span></div>
                    </td>
                    <td className={`px-3 py-2.5 text-right mono ${clr(p.chgPct)}`}>
                      <div className="text-[13px] font-semibold">{pct(p.chgPct)}</div>
                      <div className="text-[11px] opacity-80">{signed(p.todayDKK,0)}</div>
                    </td>
                    <td className={`px-3 py-2.5 text-right mono ${clr(p.glPct)}`}>
                      <div className="text-[13px] font-semibold">{pct(p.glPct)}</div>
                      <div className="text-[11px] opacity-80">{signed(p.glDKK,0)}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right text-[11px] text-gray-400 mono">
                      {n(p.weight*100,1)}%
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* ── Footer: FX rates ── */}
          <div className="px-4 py-3 text-[11px] text-gray-400 text-center border-t border-gray-100 bg-white mt-0">
            FX → DKK: &nbsp;
            USD {fx.USD.toFixed(4)} &nbsp;·&nbsp;
            EUR {fx.EUR.toFixed(4)} &nbsp;·&nbsp;
            CAD {fx.CAD.toFixed(4)}
            {!isLive && <span className="ml-2 text-amber-500">cached</span>}
          </div>
        </>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
