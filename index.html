<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Portfolio</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23111827'/%3E%3Crect x='4' y='18' width='5' height='10' rx='1' fill='%2310b981'/%3E%3Crect x='11' y='12' width='5' height='16' rx='1' fill='%2310b981'/%3E%3Crect x='18' y='6' width='5' height='22' rx='1' fill='%2310b981'/%3E%3Crect x='25' y='10' width='5' height='18' rx='1' fill='%2334d399'/%3E%3C/svg%3E">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Portfolio">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/babel" src="chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f9fa; -webkit-tap-highlight-color: transparent; }
    .mono { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const { useState, useEffect, useCallback } = React;

// ─── Portfolio seed data (one-time migration to DB on first load) ─────────
// yhTicker = Yahoo Finance symbol | cachedPrice/cachedChg = offline fallback
const SEED_PORTFOLIO = [
  { ticker:'RGTI',     yhTicker:'RGTI',        company:'Rigetti Computing',       ccy:'USD', cachedPrice:18.82,   cachedChg:0.0675  },
  { ticker:'LULU',     yhTicker:'LULU',        company:'Lululemon Athletica',     ccy:'USD', cachedPrice:187.38,  cachedChg:0.0265  },
  { ticker:'NOVO-B',   yhTicker:'NOVO-B.CO',   company:'Novo Nordisk',            ccy:'DKK', cachedPrice:239.0,   cachedChg:0.0038  },
  { ticker:'ROCK-B',   yhTicker:'ROCK-B.CO',   company:'ROCKWOOL Class B',        ccy:'DKK', cachedPrice:210.5,   cachedChg:-0.0071 },
  { ticker:'JYSK',     yhTicker:'JYSK.CO',     company:'Jyske Bank',              ccy:'DKK', cachedPrice:948.0,   cachedChg:-0.0037 },
  { ticker:'NFLX',     yhTicker:'NFLX',        company:'Netflix',                 ccy:'USD', cachedPrice:84.17,   cachedChg:0.0189  },
  { ticker:'CSU',      yhTicker:'CSU.TO',      company:'Constellation Software',  ccy:'CAD', cachedPrice:2520.0,  cachedChg:0.0246  },
  { ticker:'CHG',      yhTicker:'CHG.DE',      company:'CHAPTERS Group',          ccy:'EUR', cachedPrice:26.7,    cachedChg:-0.0220 },
  { ticker:'AAPL',     yhTicker:'AAPL',        company:'Apple',                   ccy:'USD', cachedPrice:273.63,  cachedChg:-0.0015 },
  { ticker:'GMAB',     yhTicker:'GMAB.CO',     company:'Genmab',                  ccy:'DKK', cachedPrice:1831.5,  cachedChg:-0.0008 },
  { ticker:'DANSKE',   yhTicker:'DANSKE.CO',   company:'Danske Bank',             ccy:'DKK', cachedPrice:333.0,   cachedChg:-0.0063 },
  { ticker:'ASML',     yhTicker:'ASML.AS',     company:'ASML Holding',            ccy:'EUR', cachedPrice:1250.6,  cachedChg:-0.0217 },
  { ticker:'NVDA',     yhTicker:'NVDA',        company:'NVIDIA',                  ccy:'USD', cachedPrice:188.51,  cachedChg:-0.0318 },
  { ticker:'IONQ',     yhTicker:'IONQ',        company:'IonQ',                    ccy:'USD', cachedPrice:40.76,   cachedChg:0.2186  },
  { ticker:'MSFT',     yhTicker:'MSFT',        company:'Microsoft',               ccy:'USD', cachedPrice:405.37,  cachedChg:0.0138  },
  { ticker:'V',        yhTicker:'V',           company:'Visa',                    ccy:'USD', cachedPrice:319.19,  cachedChg:0.0195  },
  { ticker:'NU',       yhTicker:'NU',          company:'Nu Holdings',             ccy:'USD', cachedPrice:15.64,   cachedChg:-0.0541 },
  { ticker:'BKNG',     yhTicker:'BKNG',        company:'Booking Holdings',        ccy:'USD', cachedPrice:4251.93, cachedChg:0.0214  },
  { ticker:'MLI',      yhTicker:'MLI',         company:'Mueller Industries',      ccy:'USD', cachedPrice:118.27,  cachedChg:-0.0027 },
  { ticker:'GOOGL',    yhTicker:'GOOGL',       company:'Alphabet',                ccy:'USD', cachedPrice:305.68,  cachedChg:-0.0231 },
  { ticker:'SNPS',     yhTicker:'SNPS',        company:'Synopsys',                ccy:'USD', cachedPrice:432.52,  cachedChg:-0.0371 },
  { ticker:'TSM',      yhTicker:'TSM',         company:'Taiwan Semiconductor',    ccy:'USD', cachedPrice:375.45,  cachedChg:-0.0282 },
  { ticker:'ADBE',     yhTicker:'ADBE',        company:'Adobe',                   ccy:'USD', cachedPrice:262.32,  cachedChg:0.0121  },
  { ticker:'QUBT',     yhTicker:'QUBT',        company:'Quantum Computing',       ccy:'USD', cachedPrice:8.95,    cachedChg:0.0346  },
  { ticker:'MAERSK-B', yhTicker:'MAERSK-B.CO', company:'A.P. Møller-Mærsk',      ccy:'DKK', cachedPrice:15200.0, cachedChg:-0.0095 },
  { ticker:'NET',      yhTicker:'NET',         company:'Cloudflare',              ccy:'USD', cachedPrice:174.61,  cachedChg:0.0176  },
  { ticker:'QBTS',     yhTicker:'QBTS',        company:'D-Wave Quantum',          ccy:'USD', cachedPrice:20.93,   cachedChg:0.0651  },
];

// ─── APIs ──────────────────────────────────────────────────────────────────
const NOTES_API        = 'https://labanos.dk/notes.php';
const TRANSACTIONS_API = 'https://labanos.dk/transactions.php';
const PORTFOLIO_API    = 'https://labanos.dk/portfolio.php';
const META_API         = 'https://labanos.dk/meta.php';
const AUTH_API         = 'https://labanos.dk/auth.php';
const PORTFOLIOS_API   = 'https://labanos.dk/portfolios.php';

// Returns fetch headers including auth token if logged in
const authHeaders = () => {
  const token = localStorage.getItem('auth_token');
  const h = { 'Content-Type': 'application/json' };
  if (token) h['Authorization'] = `Bearer ${token}`;
  return h;
};

// ─── normalizePfRow — DB row → app format ─────────────────────────────────
const normalizePfRow = (row) => {
  const seed = SEED_PORTFOLIO.find(s => s.ticker === row.ticker) || {};
  return {
    id:           row.id ? Number(row.id) : undefined,
    ticker:       row.ticker,
    yhTicker:     row.yh_ticker || row.yhTicker || row.ticker,
    company:      row.company,
    ccy:          row.ccy || seed.ccy || 'USD',
    sector:       row.sector  || null,
    country:      row.country || null,
    cachedPrice:  seed.cachedPrice  || 0,
    cachedChg:    seed.cachedChg    || 0,
  };
};

// ─── Seed transactions (one-time migration to DB on first load) ─────────────
// Each entry: { date:'YYYY-MM-DD', type:'buy'|'sell', shares, price, fees, note }
const SEED_TRANSACTIONS = {
  'RGTI': [
    { date:'2025-01-14', type:'buy', shares:100, price:9.91, fees:0 },
  ],
  'LULU': [
    { date:'2025-11-02', type:'buy', shares:53, price:164.97, fees:0 },
  ],
  'NOVO-B': [
    { date:'2022-12-29', type:'buy', shares:300, price:341.62, fees:0 },
    { date:'2025-01-06', type:'buy', shares:35, price:604.3, fees:0 },
    { date:'2025-04-29', type:'buy', shares:65, price:424.9, fees:0 },
    { date:'2025-05-05', type:'buy', shares:176, price:455.45, fees:0 },
    { date:'2025-05-08', type:'buy', shares:3, price:445.7, fees:0 },
    { date:'2025-07-28', type:'buy', shares:77, price:356.6, fees:0 },
    { date:'2025-07-30', type:'buy', shares:2, price:321.15, fees:0 },
    { date:'2025-11-26', type:'sell', shares:65, price:310.65, fees:0 },
    { date:'2025-11-26', type:'sell', shares:300, price:310.65, fees:0 },
    { date:'2025-11-26', type:'sell', shares:35, price:310.65, fees:0 },
    { date:'2026-01-06', type:'buy', shares:17, price:359.45, fees:0 },
    { date:'2026-02-22', type:'buy', shares:200, price:259.1, fees:0 },
  ],
  'ROCK-B': [
    { date:'2025-04-08', type:'buy', shares:370, price:172.73, fees:0 },
    { date:'2025-08-20', type:'buy', shares:4, price:238.9, fees:0 },
    { date:'2026-02-15', type:'buy', shares:1, price:226.15, fees:0 },
  ],
  'JYSK': [
    { date:'2022-12-29', type:'buy', shares:2018, price:278.95, fees:0 },
    { date:'2022-12-29', type:'buy', shares:133, price:171.2, fees:0 },
    { date:'2023-01-19', type:'buy', shares:25, price:481.09, fees:0 },
    { date:'2023-02-08', type:'buy', shares:24, price:517.17, fees:0 },
    { date:'2023-03-15', type:'buy', shares:25, price:478.66, fees:0 },
    { date:'2023-04-18', type:'buy', shares:24, price:517.9, fees:0 },
    { date:'2023-05-21', type:'buy', shares:26, price:479.4, fees:0 },
    { date:'2023-06-07', type:'buy', shares:23, price:522.95, fees:0 },
    { date:'2023-07-03', type:'buy', shares:24, price:521.65, fees:0 },
    { date:'2023-08-23', type:'buy', shares:25, price:486.2, fees:0 },
    { date:'2023-09-06', type:'buy', shares:25, price:492.05, fees:0 },
    { date:'2023-10-04', type:'buy', shares:25, price:488.44, fees:0 },
    { date:'2023-11-09', type:'buy', shares:26, price:474.62, fees:0 },
    { date:'2023-12-05', type:'buy', shares:25, price:476.94, fees:0 },
    { date:'2024-01-09', type:'buy', shares:27, price:504.69, fees:0 },
    { date:'2024-01-11', type:'sell', shares:184, price:543, fees:0 },
    { date:'2024-02-07', type:'buy', shares:25, price:524.58, fees:0 },
    { date:'2024-03-19', type:'buy', shares:24, price:569.26, fees:0 },
    { date:'2024-04-15', type:'buy', shares:24, price:565.98, fees:0 },
    { date:'2024-05-22', type:'buy', shares:26, price:541.88, fees:0 },
    { date:'2024-06-26', type:'buy', shares:24, price:564.78, fees:0 },
    { date:'2024-07-03', type:'buy', shares:25, price:549.4, fees:0 },
    { date:'2024-08-26', type:'buy', shares:25, price:538.85, fees:0 },
    { date:'2024-09-09', type:'buy', shares:26, price:528.07, fees:0 },
    { date:'2024-10-08', type:'buy', shares:26, price:521.73, fees:0 },
    { date:'2024-11-06', type:'buy', shares:27, price:495.75, fees:0 },
    { date:'2024-12-17', type:'buy', shares:27, price:503.13, fees:0 },
    { date:'2025-01-02', type:'sell', shares:200, price:512, fees:0 },
    { date:'2025-01-09', type:'sell', shares:100, price:506.5, fees:0 },
    { date:'2025-01-15', type:'buy', shares:26, price:530.78, fees:0 },
    { date:'2025-02-04', type:'buy', shares:27, price:515.97, fees:0 },
    { date:'2025-03-18', type:'buy', shares:23, price:590.29, fees:0 },
    { date:'2025-04-09', type:'buy', shares:30, price:470.1, fees:0 },
    { date:'2025-05-25', type:'buy', shares:22, price:623.88, fees:0 },
    { date:'2025-06-16', type:'buy', shares:22, price:636.03, fees:0 },
    { date:'2025-07-01', type:'buy', shares:22, price:638.44, fees:0 },
    { date:'2025-08-25', type:'buy', shares:20, price:710.57, fees:0 },
    { date:'2025-09-23', type:'buy', shares:19, price:705, fees:0 },
    { date:'2025-10-01', type:'buy', shares:20, price:710.49, fees:0 },
    { date:'2025-11-11', type:'buy', shares:18, price:777.74, fees:0 },
    { date:'2025-12-16', type:'buy', shares:17, price:837, fees:0 },
    { date:'2026-01-12', type:'sell', shares:100, price:882.5, fees:0 },
    { date:'2026-01-12', type:'buy', shares:16, price:883.5, fees:0 },
    { date:'2026-02-17', type:'buy', shares:15, price:938.85, fees:0 },
    { date:'2026-02-22', type:'sell', shares:100, price:961, fees:0 },
  ],
  'NFLX': [
    { date:'2022-12-28', type:'buy', shares:120, price:27.7, fees:0 },
  ],
  'CSU': [
    { date:'2025-09-30', type:'buy', shares:2, price:3968.93, fees:0 },
    { date:'2025-11-30', type:'buy', shares:3, price:3309.73, fees:0 },
    { date:'2026-02-01', type:'buy', shares:3, price:2474.63, fees:0 },
  ],
  'CHG': [
    { date:'2025-12-29', type:'buy', shares:100, price:41.2, fees:0 },
    { date:'2026-01-13', type:'buy', shares:100, price:40.5, fees:0 },
    { date:'2026-02-22', type:'buy', shares:200, price:27.25, fees:0 },
  ],
  'AAPL': [
    { date:'2023-01-17', type:'buy', shares:75, price:137.51, fees:0 },
  ],
  'GMAB': [
    { date:'2025-06-23', type:'buy', shares:22, price:1352, fees:0 },
    { date:'2025-08-07', type:'buy', shares:18, price:1420, fees:0 },
  ],
  'DANSKE': [
    { date:'2022-12-29', type:'buy', shares:336, price:135.23, fees:0 },
    { date:'2022-12-29', type:'buy', shares:710, price:105.03, fees:0 },
    { date:'2023-07-25', type:'buy', shares:1, price:161.1, fees:0 },
    { date:'2025-05-05', type:'sell', shares:336, price:242.1, fees:0 },
    { date:'2025-05-05', type:'sell', shares:1, price:242.1, fees:0 },
  ],
  'ASML': [
    { date:'2025-01-09', type:'buy', shares:10, price:732.5, fees:0 },
    { date:'2025-07-15', type:'buy', shares:10, price:660.71, fees:0 },
  ],
  'NVDA': [
    { date:'2024-08-06', type:'buy', shares:50, price:100.01, fees:0 },
    { date:'2025-05-27', type:'buy', shares:54, price:137.1, fees:0 },
  ],
  'IONQ': [
    { date:'2025-01-14', type:'buy', shares:25, price:36.88, fees:0 },
  ],
  'MSFT': [
    { date:'2024-03-04', type:'buy', shares:20, price:405.39, fees:0 },
    { date:'2025-02-25', type:'buy', shares:5, price:398.83, fees:0 },
  ],
  'V': [
    { date:'2023-01-30', type:'buy', shares:20, price:229.78, fees:0 },
  ],
  'NU': [
    { date:'2024-11-25', type:'buy', shares:300, price:13.98, fees:0 },
    { date:'2024-11-28', type:'buy', shares:150, price:12.42, fees:0 },
    { date:'2025-02-23', type:'buy', shares:350, price:11.15, fees:0 },
  ],
  'BKNG': [
    { date:'2025-02-25', type:'buy', shares:2, price:5119.75, fees:0 },
  ],
  'MLI': [
    { date:'2023-12-21', type:'buy', shares:100, price:47.16, fees:0 },
    { date:'2024-01-15', type:'buy', shares:110, price:45.27, fees:0 },
  ],
  'GOOGL': [
    { date:'2023-02-12', type:'buy', shares:181, price:95.04, fees:0 },
    { date:'2025-09-29', type:'sell', shares:31, price:241.39, fees:0 },
    { date:'2025-11-02', type:'sell', shares:30, price:282.54, fees:0 },
  ],
  'SNPS': [
    { date:'2025-10-15', type:'buy', shares:22, price:438.74, fees:0 },
    { date:'2025-11-30', type:'buy', shares:18, price:435.4, fees:0 },
  ],
  'TSM': [
    { date:'2023-01-05', type:'buy', shares:50, price:77.82, fees:0 },
    { date:'2023-01-08', type:'buy', shares:50, price:80.29, fees:0 },
  ],
  'ADBE': [
    { date:'2025-08-10', type:'buy', shares:26, price:335.74, fees:0 },
  ],
  'QUBT': [
    { date:'2025-01-14', type:'buy', shares:100, price:10.31, fees:0 },
  ],
  'MAERSK-B': [
    { date:'2023-01-10', type:'buy', shares:4, price:14580, fees:0 },
    { date:'2023-01-19', type:'buy', shares:2, price:14805, fees:0 },
    { date:'2024-03-03', type:'buy', shares:7, price:9548, fees:0 },
    { date:'2025-04-02', type:'buy', shares:2, price:10410, fees:0 },
  ],
  'NET': [
    { date:'2026-01-20', type:'buy', shares:30, price:170, fees:0 },
  ],
  'QBTS': [
    { date:'2025-01-14', type:'buy', shares:200, price:5.51, fees:0 },
  ],
};

const CACHED_FX = { USD: 6.32546, EUR: 7.471825, CAD: 4.6206, DKK: 1.0 };
// ↑ Update CACHED_AS_OF whenever you refresh the cached prices/FX above
const CACHED_AS_OF = new Date('2026-02-26T17:00:00');

// ─── Formatters ────────────────────────────────────────────────────────────
const n = (v, d=0) => isNaN(v)||v==null ? '–' : Math.abs(v).toLocaleString('da-DK', {minimumFractionDigits:d, maximumFractionDigits:d});
const pct = (v) => v==null||isNaN(v) ? '–' : (v>=0?'+':'−') + n(Math.abs(v*100),2) + '%';
const signed = (v, d=0) => v==null||isNaN(v) ? '–' : (v>=0?'+':'−') + n(Math.abs(v),d);
const clr = (v) => !v && v!==0 ? 'text-gray-400' : v > 0 ? 'text-emerald-500' : v < 0 ? 'text-red-500' : 'text-gray-400';

// ─── computePosition ───────────────────────────────────────────────────────
// Derives shares held and average cost from a transaction array
function computePosition(txns) {
  const buys  = txns.filter(t => t.type === 'buy');
  const sells = txns.filter(t => t.type === 'sell');
  const buyShares  = buys.reduce((s, t) => s + Number(t.shares), 0);
  const sellShares = sells.reduce((s, t) => s + Number(t.shares), 0);
  const buyCost    = buys.reduce((s, t) => s + Number(t.shares) * Number(t.price) + Number(t.fees || 0), 0);
  return {
    shares:  buyShares - sellShares,
    avgCost: buyShares > 0 ? buyCost / buyShares : 0,
  };
}

// ─── TransactionForm ───────────────────────────────────────────────────────
function TransactionForm({ form, onChange, onSave, onCancel, saving, error }) {
  return (
    <div className="bg-white rounded-xl border border-blue-100 shadow-sm px-4 py-3 mb-2">
      <div className="grid grid-cols-2 gap-2 mb-2">
        <div>
          <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">Date</div>
          <input type="date" value={form.date}
            onChange={e => onChange(f => ({ ...f, date: e.target.value }))}
            className="w-full text-[12px] border border-gray-200 rounded-md px-2 py-1 outline-none focus:border-blue-300" />
        </div>
        <div>
          <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">Type</div>
          <div className="flex gap-1">
            {['buy','sell'].map(t => (
              <button key={t} onClick={() => onChange(f => ({ ...f, type: t }))}
                className={`flex-1 text-[11px] font-semibold py-1 rounded-md border transition-colors ${
                  form.type === t
                    ? t === 'buy' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-red-500 text-white border-red-500'
                    : 'border-gray-200 text-gray-500 hover:bg-gray-50'
                }`}>{t.toUpperCase()}</button>
            ))}
          </div>
        </div>
      </div>
      <div className="grid grid-cols-3 gap-2 mb-2">
        {[['Shares','shares','1'],['Price','price','0.0001'],['Fees','fees','0.01']].map(([label,key,step]) => (
          <div key={key}>
            <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">{label}</div>
            <input type="number" step={step} value={form[key]}
              onChange={e => onChange(f => ({ ...f, [key]: e.target.value }))}
              placeholder={key === 'fees' ? '0' : ''}
              className="w-full text-[12px] border border-gray-200 rounded-md px-2 py-1 outline-none focus:border-blue-300 mono" />
          </div>
        ))}
      </div>
      <div className="mb-2">
        <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">Note <span className="normal-case">(optional)</span></div>
        <input type="text" value={form.note}
          onChange={e => onChange(f => ({ ...f, note: e.target.value }))}
          placeholder="Optional note…"
          className="w-full text-[12px] border border-gray-200 rounded-md px-2 py-1 outline-none focus:border-blue-300" />
      </div>
      {error && <div className="text-[11px] text-red-500 mb-1">{error}</div>}
      <div className="flex gap-2 justify-end">
        <button onClick={onCancel}
          className="text-[12px] text-gray-400 hover:text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-100 transition-colors">Cancel</button>
        <button onClick={onSave} disabled={saving || !form.shares || !form.price}
          className="text-[12px] font-medium bg-gray-900 text-white px-3 py-1.5 rounded-lg disabled:opacity-40 hover:bg-gray-700 transition-colors">
          {saving ? 'Saving…' : 'Save'}
        </button>
      </div>
    </div>
  );
}

// ─── NoteForm ──────────────────────────────────────────────────────────────
function NoteForm({ form, onChange, onSave, onCancel, saving, error, textareaRef }) {
  return (
    <div className="bg-white rounded-xl border border-blue-100 shadow-sm px-4 py-3 mb-2">
      <input
        type="date"
        value={form.date}
        onChange={e => onChange(f => ({ ...f, date: e.target.value }))}
        className="text-[11px] text-gray-500 mono border border-gray-200 rounded-md px-2 py-1 mb-2 outline-none focus:border-blue-300"
      />
      <textarea
        ref={textareaRef}
        value={form.text}
        onChange={e => onChange(f => ({ ...f, text: e.target.value }))}
        placeholder="Write your note…"
        rows={3}
        className="w-full text-[13px] text-gray-700 leading-relaxed border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-300 resize-none"
        onKeyDown={e => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') onSave(); }}
      />
      {error && <div className="text-[11px] text-red-500 mt-1">{error}</div>}
      <div className="flex gap-2 mt-2 justify-end">
        <button onClick={onCancel}
          className="text-[12px] text-gray-400 hover:text-gray-600 px-3 py-1 rounded-lg hover:bg-gray-100 transition-colors">
          Cancel
        </button>
        <button onClick={onSave} disabled={saving || !form.text.trim()}
          className="text-[12px] font-medium bg-gray-900 text-white px-3 py-1.5 rounded-lg disabled:opacity-40 hover:bg-gray-700 transition-colors">
          {saving ? 'Saving…' : 'Save'}
        </button>
      </div>
    </div>
  );
}

// ─── AddHoldingModal ───────────────────────────────────────────────────────
// ─── Portfolio Switcher ────────────────────────────────────────────────────
function PortfolioSwitcher({ portfolios, portfolioId, onSwitch, onCreateNew, onCcyChange, user }) {
  const [showMenu,   setShowMenu]   = React.useState(false);
  const [creating,   setCreating]   = React.useState(false);
  const [renaming,   setRenaming]   = React.useState(null); // portfolio object
  const [newName,    setNewName]    = React.useState('');
  const [saving,     setSaving]     = React.useState(false);
  const current = portfolios.find(p => p.id === portfolioId);

  const createPortfolio = async () => {
    if (!newName.trim()) return;
    setSaving(true);
    const token = localStorage.getItem('auth_token');
    const res = await fetch(PORTFOLIOS_API, {
      method: 'POST', headers: authHeaders(),
      body: JSON.stringify({ name: newName.trim() }),
    });
    if (res.ok) {
      const pf = await res.json();
      onCreateNew(pf);
      setNewName(''); setCreating(false);
    }
    setSaving(false);
  };

  const renamePortfolio = async () => {
    if (!newName.trim() || !renaming) return;
    setSaving(true);
    const res = await fetch(`${PORTFOLIOS_API}?id=${renaming.id}&_method=PUT`, {
      method: 'POST', headers: authHeaders(),
      body: JSON.stringify({ name: newName.trim() }),
    });
    if (res.ok) { onCreateNew({ ...renaming, name: newName.trim(), _rename: true }); setRenaming(null); setNewName(''); }
    setSaving(false);
  };

  const deletePortfolio = async (pf) => {
    if (!window.confirm(`Delete "${pf.name}"? This only works if the portfolio has no holdings.`)) return;
    const res = await fetch(`${PORTFOLIOS_API}?id=${pf.id}&_method=DELETE`, { method: 'POST', headers: authHeaders() });
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Could not delete'); return; }
    onCreateNew({ ...pf, _deleted: true });
  };

  if (creating || renaming) {
    return (
      <div className="flex items-center gap-1">
        <input autoFocus value={newName} onChange={e => setNewName(e.target.value)}
          onKeyDown={e => { if (e.key === 'Enter') creating ? createPortfolio() : renamePortfolio(); if (e.key === 'Escape') { setCreating(false); setRenaming(null); } }}
          placeholder={creating ? 'Portfolio name…' : renaming?.name}
          className="bg-gray-800 text-white text-[12px] rounded-lg px-2 py-1 outline-none border border-gray-600 w-36" />
        <button onClick={creating ? createPortfolio : renamePortfolio} disabled={saving}
          className="text-[11px] bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded-lg text-white disabled:opacity-50">
          {saving ? '…' : 'Save'}
        </button>
        <button onClick={() => { setCreating(false); setRenaming(null); }} className="text-gray-400 hover:text-white text-[11px] px-1">✕</button>
      </div>
    );
  }

  return (
    <div className="relative">
      <button onClick={() => setShowMenu(m => !m)}
        className="flex items-center gap-1 text-[12px] text-gray-200 hover:text-white bg-gray-800 hover:bg-gray-700 px-2.5 py-1 rounded-lg transition-colors max-w-[120px]">
        <span className="truncate">{current?.name || 'Portfolio'}</span>
        <span className="text-gray-400 text-[10px]">▾</span>
      </button>
      {showMenu && (
        <div className="absolute left-0 top-full mt-1 bg-white rounded-xl shadow-xl border border-gray-100 z-50 min-w-[180px] py-1 overflow-hidden">
          {portfolios.map(pf => (
            <div key={pf.id} className={`flex items-center justify-between px-3 py-2 hover:bg-gray-50 ${pf.id === portfolioId ? 'bg-blue-50' : ''}`}>
              <button onClick={() => { onSwitch(pf.id, pf.base_currency); setShowMenu(false); }}
                className={`flex-1 text-left text-[13px] ${pf.id === portfolioId ? 'font-semibold text-blue-700' : 'text-gray-700'}`}>
                {pf.name}
                {pf.id === portfolioId && <span className="ml-1 text-[10px]">✓</span>}
              </button>
              {user && portfolios.length > 1 && (
                <div className="flex gap-0.5 ml-1">
                  <button onClick={() => { setRenaming(pf); setNewName(pf.name); setShowMenu(false); }}
                    className="text-gray-300 hover:text-blue-500 text-[12px] px-1">✎</button>
                  <button onClick={() => { deletePortfolio(pf); setShowMenu(false); }}
                    className="text-gray-300 hover:text-red-500 text-[12px] px-1">✕</button>
                </div>
              )}
            </div>
          ))}
          {user && onCcyChange && (() => {
            const activePf = portfolios.find(p => p.id === portfolioId);
            return (
              <div className="px-3 py-2 flex items-center justify-between border-t border-gray-100">
                <span className="text-[11px] text-gray-400">Display currency</span>
                <select
                  value={activePf?.base_currency || 'DKK'}
                  onClick={e => e.stopPropagation()}
                  onChange={e => { e.stopPropagation(); onCcyChange(portfolioId, e.target.value); setShowMenu(false); }}
                  className="text-[12px] border border-gray-200 rounded px-1.5 py-0.5 bg-white outline-none focus:border-blue-300 cursor-pointer ml-2">
                  {['DKK','USD','EUR','GBP','CAD','SEK','NOK'].map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
            );
          })()}
          {user && (
            <button onClick={() => { setCreating(true); setNewName(''); setShowMenu(false); }}
              className="w-full text-left px-3 py-2 text-[12px] text-blue-600 hover:bg-blue-50 border-t border-gray-100 font-medium">
              + New portfolio
            </button>
          )}
        </div>
      )}
    </div>
  );
}

// ─── Login Modal ───────────────────────────────────────────────────────────
function LoginModal({ onLogin, onClose }) {
  const [email,    setEmail]    = useState('');
  const [password, setPassword] = useState('');
  const [error,    setError]    = useState(null);
  const [loading,  setLoading]  = useState(false);

  const submit = async (e) => {
    e.preventDefault();
    setLoading(true); setError(null);
    try {
      const res  = await fetch(AUTH_API, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      const data = await res.json();
      if (!res.ok) { setError(data.error || 'Login failed'); setLoading(false); return; }
      onLogin(data);
    } catch (_) { setError('Could not connect — check your connection.'); setLoading(false); }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />
      <div className="relative bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl px-6 pt-5 pb-8">
        <div className="flex items-center justify-between mb-5">
          <h2 className="font-bold text-gray-900 text-[16px]">Sign in to edit</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-xl px-1">✕</button>
        </div>
        <form onSubmit={submit} className="space-y-4">
          <div>
            <label className="block text-[11px] text-gray-400 uppercase tracking-wide mb-1">Email</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} required autoFocus
              className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="you@example.com" />
          </div>
          <div>
            <label className="block text-[11px] text-gray-400 uppercase tracking-wide mb-1">Password</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} required
              className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500" />
          </div>
          {error && <p className="text-red-500 text-[12px] bg-red-50 px-3 py-2 rounded-lg">{error}</p>}
          <button type="submit" disabled={loading}
            className="w-full bg-gray-900 hover:bg-gray-700 text-white font-semibold py-3 rounded-xl text-[14px] disabled:opacity-50 transition-colors">
            {loading ? 'Signing in…' : 'Sign in'}
          </button>
        </form>
      </div>
    </div>
  );
}

// ─── First-Time Setup Modal ─────────────────────────────────────────────────
function SetupModal({ onComplete }) {
  const [name,     setName]     = useState('');
  const [email,    setEmail]    = useState('');
  const [password, setPassword] = useState('');
  const [error,    setError]    = useState(null);
  const [loading,  setLoading]  = useState(false);

  const submit = async (e) => {
    e.preventDefault();
    setLoading(true); setError(null);
    try {
      const res  = await fetch(`${AUTH_API}?setup=1`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, password }),
      });
      const data = await res.json();
      if (!res.ok) { setError(data.error || 'Setup failed'); setLoading(false); return; }
      onComplete(data);
    } catch (_) { setError('Could not connect — check your connection.'); setLoading(false); }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-gray-900/80">
      <div className="relative bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl px-6 pt-5 pb-8">
        <h2 className="font-bold text-gray-900 text-[16px] mb-1">Create your account</h2>
        <p className="text-[12px] text-gray-400 mb-5">First-time setup — only runs once.</p>
        <form onSubmit={submit} className="space-y-4">
          <div>
            <label className="block text-[11px] text-gray-400 uppercase tracking-wide mb-1">Your name</label>
            <input type="text" value={name} onChange={e => setName(e.target.value)} required autoFocus
              className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Peter" />
          </div>
          <div>
            <label className="block text-[11px] text-gray-400 uppercase tracking-wide mb-1">Email</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} required
              className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="you@example.com" />
          </div>
          <div>
            <label className="block text-[11px] text-gray-400 uppercase tracking-wide mb-1">Password</label>
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} required minLength={6}
              className="w-full border border-gray-200 rounded-xl px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="At least 6 characters" />
          </div>
          {error && <p className="text-red-500 text-[12px] bg-red-50 px-3 py-2 rounded-lg">{error}</p>}
          <button type="submit" disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-xl text-[14px] disabled:opacity-50 transition-colors">
            {loading ? 'Creating account…' : 'Create account'}
          </button>
        </form>
      </div>
    </div>
  );
}

function AddHoldingModal({ onClose, onAdded, portfolioId }) {
  const today = new Date().toISOString().split('T')[0];
  const [form, setForm] = useState({
    ticker: '', yhTicker: '', company: '', ccy: 'USD',
    date: today, type: 'buy', shares: '', price: '', fees: '0', note: '',
  });
  const [saving, setSaving] = useState(false);
  const [error,  setError]  = useState(null);

  const set = (key, val) => setForm(f => ({ ...f, [key]: val }));

  const handleSave = async () => {
    const ticker = form.ticker.trim().toUpperCase();
    if (!ticker || !form.company.trim() || !form.shares || !form.price) {
      setError('Please fill in all required fields.'); return;
    }
    setSaving(true); setError(null);
    try {
      // 1. Create portfolio entry
      const portRes = await fetch(PORTFOLIO_API, {
        method: 'POST', headers: authHeaders(),
        body: JSON.stringify({
          ticker, company: form.company.trim(),
          yhTicker: form.yhTicker.trim() || ticker, ccy: form.ccy,
          portfolio_id: portfolioId,
        }),
      });
      if (!portRes.ok) {
        const err = await portRes.json().catch(() => ({}));
        throw new Error(err.error || 'Could not add holding');
      }
      const portEntry = await portRes.json();

      // 2. Create opening transaction
      const txnRes = await fetch(TRANSACTIONS_API, {
        method: 'POST', headers: authHeaders(),
        body: JSON.stringify({
          ticker, date: form.date, type: form.type,
          portfolio_id: portfolioId,
          shares: parseFloat(form.shares), price: parseFloat(form.price),
          fees: parseFloat(form.fees) || 0, note: form.note.trim(),
        }),
      });
      if (!txnRes.ok) throw new Error('Could not add opening transaction');
      const txn = await txnRes.json();

      onAdded(normalizePfRow(portEntry), txn);
      onClose();
    } catch (e) {
      setError(e.message || 'Something went wrong.');
    }
    setSaving(false);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="relative bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl px-4 pt-4 pb-8 max-h-[90vh] overflow-y-auto">

        <div className="flex items-center justify-between mb-4">
          <h2 className="text-[15px] font-bold text-gray-900">Add New Holding</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-xl leading-none px-1">✕</button>
        </div>

        {/* Ticker + Currency */}
        <div className="grid grid-cols-2 gap-2 mb-3">
          <div>
            <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Ticker *</label>
            <input type="text" value={form.ticker}
              onChange={e => set('ticker', e.target.value.toUpperCase())}
              placeholder="e.g. AAPL"
              className="w-full text-[13px] font-semibold border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-300 uppercase" />
          </div>
          <div>
            <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Currency *</label>
            <select value={form.ccy} onChange={e => set('ccy', e.target.value)}
              className="w-full text-[13px] border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-300 bg-white">
              {['USD','DKK','EUR','CAD','GBP','SEK','NOK'].map(c => <option key={c}>{c}</option>)}
            </select>
          </div>
        </div>

        {/* Company */}
        <div className="mb-3">
          <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Company Name *</label>
          <input type="text" value={form.company} onChange={e => set('company', e.target.value)}
            placeholder="e.g. Apple Inc."
            className="w-full text-[13px] border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-300" />
        </div>

        {/* Yahoo Finance ticker */}
        <div className="mb-4">
          <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Yahoo Finance Ticker</label>
          <input type="text" value={form.yhTicker} onChange={e => set('yhTicker', e.target.value)}
            placeholder={form.ticker || 'Leave blank if same as ticker'}
            className="w-full text-[13px] border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-blue-300 mono" />
          <p className="text-[10px] text-gray-400 mt-1">e.g. NOVO-B.CO for Danish, CSU.TO for TSX, CHG.DE for Xetra</p>
        </div>

        {/* Opening transaction */}
        <div className="border-t border-gray-100 pt-4 mb-3">
          <div className="text-[11px] font-semibold text-gray-500 uppercase tracking-wide mb-3">Opening Transaction</div>

          <div className="grid grid-cols-2 gap-2 mb-2">
            <div>
              <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Date *</label>
              <input type="date" value={form.date} onChange={e => set('date', e.target.value)}
                className="w-full text-[12px] border border-gray-200 rounded-lg px-2 py-2 outline-none focus:border-blue-300" />
            </div>
            <div>
              <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Type</label>
              <div className="flex gap-1">
                {['buy','sell'].map(t => (
                  <button key={t} onClick={() => set('type', t)}
                    className={`flex-1 text-[11px] font-semibold py-2 rounded-lg border transition-colors ${
                      form.type === t
                        ? t === 'buy' ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-red-500 text-white border-red-500'
                        : 'border-gray-200 text-gray-500 hover:bg-gray-50'
                    }`}>{t.toUpperCase()}</button>
                ))}
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-2 mb-2">
            {[['Shares *','shares','1'],['Price *','price','0.0001'],['Fees','fees','0.01']].map(([label,key,step]) => (
              <div key={key}>
                <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">{label}</label>
                <input type="number" step={step} value={form[key]}
                  onChange={e => set(key, e.target.value)}
                  placeholder={key === 'fees' ? '0' : ''}
                  className="w-full text-[12px] border border-gray-200 rounded-lg px-2 py-2 outline-none focus:border-blue-300 mono" />
              </div>
            ))}
          </div>

          <div>
            <label className="text-[10px] text-gray-400 uppercase tracking-wide block mb-0.5">Note (optional)</label>
            <input type="text" value={form.note} onChange={e => set('note', e.target.value)}
              placeholder="Optional note…"
              className="w-full text-[12px] border border-gray-200 rounded-lg px-2 py-2 outline-none focus:border-blue-300" />
          </div>
        </div>

        {error && <div className="text-[12px] text-red-500 mb-3 bg-red-50 px-3 py-2 rounded-lg">{error}</div>}

        <button onClick={handleSave} disabled={saving}
          className="w-full py-3 bg-gray-900 text-white font-semibold rounded-xl text-[14px] hover:bg-gray-700 disabled:opacity-40 transition-colors">
          {saving ? 'Adding…' : 'Add Holding'}
        </button>
      </div>
    </div>
  );
}

// ─── Detail Page ───────────────────────────────────────────────────────────
function DetailPage({ position: p, initialTxns, onBack, onTxnsChanged, onRemoveHolding, user, onRequireLogin, portfolioId, isLive, lastUpdated, baseCcy }) {

  // ── Transactions state ──────────────────────────────────────────────────
  const [txns,         setTxns]        = useState(initialTxns || []);
  const [addingTxn,    setAddingTxn]   = useState(false);
  const [editingTxnId, setEditingTxnId]= useState(null);
  const [txnForm,      setTxnForm]     = useState({ date:'', type:'buy', shares:'', price:'', fees:'0', note:'' });
  const [savingTxn,    setSavingTxn]   = useState(false);
  const [txnError,     setTxnError]    = useState(null);
  const [removing,     setRemoving]    = useState(false);

  const todayStrT = () => new Date().toISOString().split('T')[0];
  const sortTxns  = arr => [...arr].sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);

  const openAddTxn = () => {
    setAddingTxn(true); setEditingTxnId(null);
    setTxnForm({ date: todayStrT(), type:'buy', shares:'', price:'', fees:'0', note:'' });
    setTxnError(null);
  };
  const openEditTxn = (t) => {
    setEditingTxnId(t.id); setAddingTxn(false);
    setTxnForm({ date:t.date, type:t.type, shares:String(t.shares), price:String(t.price), fees:String(t.fees), note:t.note||'' });
    setTxnError(null);
  };
  const cancelTxn = () => { setAddingTxn(false); setEditingTxnId(null); setTxnError(null); };

  const saveTxn = async () => {
    if (!txnForm.shares || !txnForm.price) return;
    setSavingTxn(true); setTxnError(null);
    const payload = {
      ticker:       p.ticker,
      portfolio_id: portfolioId,
      date:         txnForm.date,
      type:         txnForm.type,
      shares:       parseFloat(txnForm.shares),
      price:        parseFloat(txnForm.price),
      fees:         parseFloat(txnForm.fees  || 0),
      note:         txnForm.note.trim(),
    };
    try {
      if (addingTxn) {
        const res = await fetch(TRANSACTIONS_API, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error();
        const created = await res.json();
        const next = sortTxns([...txns, created]);
        setTxns(next); onTxnsChanged(p.ticker, next);
      } else {
        const res = await fetch(`${TRANSACTIONS_API}?id=${editingTxnId}&_method=PUT`, {
          method: 'POST', headers: authHeaders(),
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error();
        const next = sortTxns(txns.map(t => t.id === editingTxnId ? { ...t, ...payload, id: editingTxnId } : t));
        setTxns(next); onTxnsChanged(p.ticker, next);
      }
      cancelTxn();
    } catch (_) { setTxnError('Could not save — check your connection.'); }
    setSavingTxn(false);
  };

  const deleteTxn = async (id) => {
    if (!window.confirm('Delete this transaction?')) return;
    try {
      await fetch(`${TRANSACTIONS_API}?id=${id}&_method=DELETE`, { method: 'POST' });
      const next = txns.filter(t => t.id !== id);
      setTxns(next); onTxnsChanged(p.ticker, next);
    } catch (_) { setTxnError('Could not delete — check your connection.'); }
  };

  // ── Notes state ────────────────────────────────────────────────────────
  const [notes,      setNotes]      = useState([]);
  const [notesReady, setNotesReady] = useState(false);
  const [addingNote, setAddingNote] = useState(false);
  const [editingId,  setEditingId]  = useState(null);
  const [noteForm,   setNoteForm]   = useState({ date: '', text: '' });
  const [saving,     setSaving]     = useState(false);
  const [noteError,  setNoteError]  = useState(null);
  const textareaRef = React.useRef(null);

  useEffect(() => {
    setNotesReady(false);
    fetch(`${NOTES_API}?ticker=${encodeURIComponent(p.ticker)}&portfolio_id=${portfolioId}`)
      .then(r => r.ok ? r.json() : [])
      .then(data => { setNotes(Array.isArray(data) ? data : []); setNotesReady(true); })
      .catch(()  => { setNotes([]); setNotesReady(true); });
  }, [p.ticker]);

  const todayStr = () => new Date().toISOString().split('T')[0];
  const sortNotes = arr => [...arr].sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);

  const openAdd = () => {
    setAddingNote(true); setEditingId(null);
    setNoteForm({ date: todayStr(), text: '' }); setNoteError(null);
    setTimeout(() => textareaRef.current?.focus(), 60);
  };
  const openEdit = (note) => {
    setEditingId(note.id); setAddingNote(false);
    setNoteForm({ date: note.date, text: note.text }); setNoteError(null);
  };
  const cancelNote = () => {
    setAddingNote(false); setEditingId(null);
    setNoteForm({ date: '', text: '' }); setNoteError(null);
  };

  const saveNote = async () => {
    if (!noteForm.text.trim()) return;
    setSaving(true); setNoteError(null);
    try {
      if (addingNote) {
        const res = await fetch(NOTES_API, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ ticker: p.ticker, portfolio_id: portfolioId, date: noteForm.date, text: noteForm.text.trim() }),
        });
        if (!res.ok) throw new Error();
        const created = await res.json();
        setNotes(prev => sortNotes([...prev, created]));
      } else {
        const res = await fetch(`${NOTES_API}?id=${editingId}&_method=PUT`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({ date: noteForm.date, text: noteForm.text.trim() }),
        });
        if (!res.ok) throw new Error();
        setNotes(prev => sortNotes(prev.map(n =>
          n.id === editingId ? { ...n, date: noteForm.date, text: noteForm.text.trim() } : n
        )));
      }
      cancelNote();
    } catch (_) {
      setNoteError('Could not save — check your connection and try again.');
    }
    setSaving(false);
  };

  const deleteNote = async (id) => {
    if (!window.confirm('Delete this note?')) return;
    try {
      await fetch(`${NOTES_API}?id=${id}&_method=DELETE`, { method: 'POST' });
      setNotes(prev => prev.filter(n => n.id !== id));
    } catch (_) {
      setNoteError('Could not delete — check your connection.');
    }
  };

  const removeHolding = async () => {
    const txnCount = txns.length;
    const msg = txnCount > 0
      ? `Remove ${p.ticker} from your portfolio?\n\nThis will also permanently delete ${txnCount} transaction${txnCount !== 1 ? 's' : ''} for this holding. This cannot be undone.`
      : `Remove ${p.ticker} from your portfolio? This cannot be undone.`;
    if (!window.confirm(msg)) return;
    setRemoving(true);
    try {
      if (txnCount > 0) {
        await fetch(`${TRANSACTIONS_API}?ticker=${encodeURIComponent(p.ticker)}&_method=DELETE`, { method: 'POST' });
      }
      if (p.id) {
        await fetch(`${PORTFOLIO_API}?id=${p.id}&_method=DELETE`, { method: 'POST' });
      }
      onRemoveHolding(p.ticker);
    } catch (_) {
      setRemoving(false);
      alert('Could not remove holding — check your connection.');
    }
  };

  const totalBought = txns.filter(t=>t.type==='buy').reduce((s,t)=>s+(t.shares*t.price+t.fees),0);
  const totalSold   = txns.filter(t=>t.type==='sell').reduce((s,t)=>s+(t.shares*t.price-t.fees),0);

  const fmtDate = (d) => {
    const [y,m,day] = d.split('-');
    return `${day}.${m}.${y}`;
  };

  const typeTag = (type) => type === 'buy'
    ? <span className="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-emerald-100 text-emerald-700">BUY</span>
    : <span className="inline-block px-1.5 py-0.5 rounded text-[10px] font-semibold bg-red-100 text-red-600">SELL</span>;

  return (
    <div className="min-h-screen bg-gray-50 pb-12">

      {/* ── Header ── */}
      <div className="bg-gray-900 text-white px-4 py-3 flex items-center gap-3 sticky top-0 z-20">
        <button onClick={onBack} className="text-gray-400 hover:text-white transition-colors text-sm flex items-center gap-1">
          ← Portfolio
        </button>
        <div className="flex-1 flex items-center gap-2 min-w-0">
          <span className="font-bold text-lg">{p.ticker}</span>
          <span className="text-gray-400 text-sm truncate">{p.company}</span>
        </div>
        <span className={`text-[11px] px-2 py-0.5 rounded-full ${isLive ? 'bg-emerald-500 text-white' : 'bg-gray-600 text-gray-300'}`}>
          {isLive ? 'live' : 'cached'}
        </span>
      </div>

      {/* ── Stats row ── */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-4">
        {[
          { label: 'Price', value: p.price >= 1000 ? n(p.price,0) : n(p.price,2), sub: p.ccy },
          { label: 'Today', value: pct(p.chgPct), sub: signed(p.todayBase,0)+' '+baseCcy, color: clr(p.chgPct) },
          { label: 'Total G/L', value: pct(p.glPct), sub: signed(p.glBase,0)+' '+baseCcy, color: clr(p.glPct) },
          { label: 'Position', value: p.shares+' shares', sub: 'avg '+n(p.avgCost,2)+' '+p.ccy },
        ].map(({ label, value, sub, color }) => (
          <div key={label} className="bg-white rounded-xl px-4 py-3 shadow-sm border border-gray-100">
            <div className="text-[11px] text-gray-400 mb-1">{label}</div>
            <div className={`font-semibold text-[16px] mono ${color||'text-gray-900'}`}>{value}</div>
            <div className={`text-[11px] mono mt-0.5 ${color||'text-gray-400'}`}>{sub}</div>
          </div>
        ))}
      </div>

      {/* ── Chart ── */}
      <div className="mx-4 mb-2">
        <StockChart yhTicker={p.yhTicker} ccy={p.ccy} />
      </div>

      {/* ── Transactions ── */}
      <div className="mx-4 mb-6">
        <div className="flex items-center justify-between mb-2">
          <h2 className="text-[13px] font-semibold text-gray-600 uppercase tracking-wide">Transactions</h2>
          {!addingTxn && user && (
            <button onClick={openAddTxn}
              className="text-[12px] text-blue-500 hover:text-blue-600 font-medium px-2 py-1 rounded-lg hover:bg-blue-50 transition-colors">
              + Add
            </button>
          )}
        </div>

        {/* Add form */}
        {addingTxn && (
          <TransactionForm form={txnForm} onChange={setTxnForm} onSave={saveTxn}
            onCancel={cancelTxn} saving={savingTxn} error={txnError} />
        )}

        {txns.length === 0 && !addingTxn ? (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-6 text-center text-gray-400 text-sm">
            No transactions yet{user ? (
              <> — <button onClick={openAddTxn} className="text-blue-400 font-medium hover:underline">add one</button></>
            ) : '.'}
          </div>
        ) : txns.length > 0 && (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
            {txnError && !addingTxn && !editingTxnId && (
              <div className="px-4 py-2 text-[11px] text-red-500 bg-red-50">{txnError}</div>
            )}
            <table className="w-full text-[12px]">
              <thead>
                <tr className="border-b border-gray-100 text-gray-400 text-[11px] uppercase tracking-wide">
                  <th className="px-3 py-2 text-left">Date</th>
                  <th className="px-3 py-2 text-left">Type</th>
                  <th className="px-3 py-2 text-right">Shares</th>
                  <th className="px-3 py-2 text-right">Price</th>
                  <th className="px-3 py-2 text-right">Fees</th>
                  <th className="px-3 py-2 text-right">Value</th>
                  <th className="px-3 py-2 text-left">Note</th>
                  <th className="px-2 py-2"></th>
                </tr>
              </thead>
              <tbody>
                {txns.map((t, i) =>
                  editingTxnId === t.id ? (
                    <tr key={t.id}>
                      <td colSpan={8} className="p-2">
                        <TransactionForm form={txnForm} onChange={setTxnForm} onSave={saveTxn}
                          onCancel={cancelTxn} saving={savingTxn} error={txnError} />
                      </td>
                    </tr>
                  ) : (
                    <tr key={t.id} className={`border-b border-gray-50 ${i%2===0?'bg-white':'bg-gray-50/40'}`}>
                      <td className="px-3 py-2 mono text-gray-500">{fmtDate(t.date)}</td>
                      <td className="px-3 py-2">{typeTag(t.type)}</td>
                      <td className="px-3 py-2 text-right mono text-gray-700">{n(t.shares,0)}</td>
                      <td className="px-3 py-2 text-right mono text-gray-700">{n(t.price,2)}</td>
                      <td className="px-3 py-2 text-right mono text-gray-400">{t.fees ? n(t.fees,2) : '–'}</td>
                      <td className={`px-3 py-2 text-right mono font-medium ${t.type==='buy'?'text-gray-700':'text-emerald-600'}`}>
                        {t.type==='buy' ? '−'+n(t.shares*t.price+(t.fees||0),0) : '+'+n(t.shares*t.price-(t.fees||0),0)}
                      </td>
                      <td className="px-3 py-2 text-gray-500 max-w-[140px] truncate">{t.note||''}</td>
                      <td className="px-2 py-2 whitespace-nowrap">
                        {user && (<><button onClick={() => openEditTxn(t)} title="Edit"
                          className="text-gray-300 hover:text-blue-400 transition-colors text-[13px] px-1">✎</button>
                        <button onClick={() => deleteTxn(t.id)} title="Delete"
                          className="text-gray-300 hover:text-red-400 transition-colors text-[13px] px-1">✕</button></>)}
                      </td>
                    </tr>
                  )
                )}
              </tbody>
              {txns.length > 1 && (
                <tfoot className="border-t border-gray-200 bg-gray-50 text-[11px] text-gray-500">
                  <tr>
                    <td colSpan={5} className="px-3 py-2">Total invested / received</td>
                    <td className="px-3 py-2 text-right mono font-semibold text-gray-700">
                      {totalBought > 0 && <span className="text-gray-700">−{n(totalBought,0)}</span>}
                      {totalSold > 0 && <span className="text-emerald-600 ml-2">+{n(totalSold,0)}</span>}
                    </td>
                    <td /><td />
                  </tr>
                </tfoot>
              )}
            </table>
          </div>
        )}
      </div>

      {/* ── Notes & Diary ── */}
      <div className="mx-4">
        <div className="flex items-center justify-between mb-2">
          <h2 className="text-[13px] font-semibold text-gray-600 uppercase tracking-wide">Notes & Diary</h2>
          {!addingNote && user && (
            <button onClick={openAdd}
              className="text-[12px] text-blue-500 hover:text-blue-600 font-medium px-2 py-1 rounded-lg hover:bg-blue-50 transition-colors">
              + Add note
            </button>
          )}
        </div>

        {/* Add form */}
        {addingNote && (
          <NoteForm
            form={noteForm}
            onChange={setNoteForm}
            onSave={saveNote}
            onCancel={cancelNote}
            saving={saving}
            error={noteError}
            textareaRef={textareaRef}
          />
        )}

        {/* Notes list */}
        {!notesReady ? (
          <div className="text-center text-gray-400 text-sm py-6">Loading notes…</div>
        ) : notes.length === 0 && !addingNote ? (
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-6 text-center text-gray-400 text-sm">
            No notes yet{user ? (
              <> — <button onClick={openAdd} className="text-blue-400 font-medium hover:underline">add one</button></>
            ) : '.'}
          </div>
        ) : (
          <div className="flex flex-col gap-2">
            {notes.map((note) =>
              editingId === note.id ? (
                <NoteForm
                  key={note.id}
                  form={noteForm}
                  onChange={setNoteForm}
                  onSave={saveNote}
                  onCancel={cancelNote}
                  saving={saving}
                  error={noteError}
                />
              ) : (
                <div key={note.id} className="bg-white rounded-xl border border-gray-100 shadow-sm px-4 py-3">
                  <div className="flex items-start justify-between gap-2">
                    <div className="text-[11px] text-gray-400 mono">{fmtDate(note.date)}</div>
                    <div className="flex gap-1 shrink-0 -mt-0.5">
                      {user && (<><button onClick={() => openEdit(note)} title="Edit"
                        className="text-gray-300 hover:text-blue-400 transition-colors text-[14px] px-1 leading-none">✎</button>
                      <button onClick={() => deleteNote(note.id)} title="Delete"
                        className="text-gray-300 hover:text-red-400 transition-colors text-[14px] px-1 leading-none">✕</button></>)}
                    </div>
                  </div>
                  <p className="text-[13px] text-gray-700 leading-relaxed whitespace-pre-wrap mt-1">{note.text}</p>
                </div>
              )
            )}
          </div>
        )}
      </div>

      {/* ── Remove holding ── */}
      {user && (
      <div className="px-4 pt-6 pb-2">
        <button
          onClick={removeHolding}
          disabled={removing}
          className="text-[12px] text-red-400 hover:text-red-600 transition-colors disabled:opacity-40"
        >
          {removing ? 'Removing…' : '✕ Remove this holding'}
        </button>
      </div>
      )}

    </div>
  );
}

// ─── Insights: colour palette ─────────────────────────────────────────────
const INSIGHT_PALETTE = [
  '#6366f1','#10b981','#f59e0b','#3b82f6','#ef4444',
  '#8b5cf6','#14b8a6','#f97316','#ec4899','#84cc16',
];

// ─── PieChart — pure SVG donut ─────────────────────────────────────────────
const PIE_LEGEND_MAX = 10;

function PieChart({ data }) {
  const [hovered,   setHovered]   = React.useState(null);
  const [collapsed, setCollapsed] = React.useState(true);

  const size = 200, cx = 100, cy = 100, R = 80, r = 50;
  const total = data.reduce((s, d) => s + d.value, 0);
  if (total === 0) return null;

  let angle = -Math.PI / 2;
  const slices = data.map((d) => {
    const sweep = (d.value / total) * Math.PI * 2;
    const s = { ...d, start: angle, end: angle + sweep };
    angle += sweep;
    return s;
  });

  const pt = (a, rad) => ({ x: cx + rad * Math.cos(a), y: cy + rad * Math.sin(a) });
  const arc = (s, e, outerR) => {
    const p1 = pt(s, outerR), p2 = pt(e, outerR), p3 = pt(e, r), p4 = pt(s, r);
    const lg = e - s > Math.PI ? 1 : 0;
    return `M${p1.x} ${p1.y} A${outerR} ${outerR} 0 ${lg} 1 ${p2.x} ${p2.y} L${p3.x} ${p3.y} A${r} ${r} 0 ${lg} 0 ${p4.x} ${p4.y}Z`;
  };

  const hSlice = hovered !== null ? slices[hovered] : null;
  const visibleSlices = collapsed ? slices.slice(0, PIE_LEGEND_MAX) : slices;
  const hiddenCount   = slices.length - PIE_LEGEND_MAX;

  return (
    <div className="flex flex-col sm:flex-row items-start gap-6" style={{ maxWidth: 560 }}>
      <svg width={size} height={size} style={{ flexShrink: 0 }}>
        {slices.map((s, i) => (
          <path key={i}
            d={arc(s.start, s.end, hovered === i ? R + 7 : R)}
            fill={s.color}
            opacity={hovered !== null && hovered !== i ? 0.55 : 1}
            style={{ cursor: 'pointer', transition: 'all 0.12s ease' }}
            onMouseEnter={() => setHovered(i)}
            onMouseLeave={() => setHovered(null)}
          />
        ))}
        {hSlice ? (
          <>
            <text x={cx} y={cy - 7} textAnchor="middle" fontSize="14" fontWeight="700" fill="#111827">
              {(hSlice.value / total * 100).toFixed(1)}%
            </text>
            <text x={cx} y={cy + 10} textAnchor="middle" fontSize="9.5" fill="#6b7280">
              {hSlice.label.length > 13 ? hSlice.label.slice(0, 13) + '…' : hSlice.label}
            </text>
          </>
        ) : (
          <text x={cx} y={cy + 5} textAnchor="middle" fontSize="11" fill="#d1d5db">
            {data.length} {data.length === 1 ? 'item' : 'items'}
          </text>
        )}
      </svg>

      {/* Legend */}
      <div className="flex flex-col gap-0.5 min-w-0" style={{ width: 300 }}>
        {visibleSlices.map((s, i) => (
          <div key={i}
            className="flex items-center gap-2 cursor-default py-0.5"
            onMouseEnter={() => setHovered(i)}
            onMouseLeave={() => setHovered(null)}
          >
            <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{ backgroundColor: s.color }} />
            <span className={`text-[12px] truncate transition-colors ${hovered === i ? 'font-semibold text-gray-900' : 'text-gray-600'}`}
                  style={{ maxWidth: 180 }}>
              {s.label}
            </span>
            <span className="text-[11px] text-gray-400 ml-auto flex-shrink-0 mono">
              {(s.value / total * 100).toFixed(1)}%
            </span>
          </div>
        ))}
        {slices.length > PIE_LEGEND_MAX && (
          <button
            onClick={() => setCollapsed(v => !v)}
            className="mt-1 text-[11px] text-gray-400 hover:text-gray-600 text-left transition-colors"
          >
            {collapsed
              ? `▸ Show ${hiddenCount} more`
              : `▴ Show less`}
          </button>
        )}
      </div>
    </div>
  );
}

// ─── InsightsPanel ─────────────────────────────────────────────────────────
function InsightsPanel({ positions, baseCcy, metaLoading }) {
  const [view, setView] = React.useState('ticker');

  const active = positions.filter(p => p.shares > 0 && p.valueBase > 0);

  const groupBy = (field) => {
    const acc = {};
    active.forEach(p => {
      const key = (p[field] && p[field] !== 'Unknown' ? p[field] : 'Unknown');
      acc[key] = (acc[key] || 0) + p.valueBase;
    });
    return Object.entries(acc)
      .sort((a, b) => b[1] - a[1])
      .map(([label, value], i) => ({
        label,
        value,
        color: i < INSIGHT_PALETTE.length ? INSIGHT_PALETTE[i] : '#9ca3af',
      }));
  };

  const tickerData = active
    .slice()
    .sort((a, b) => b.valueBase - a.valueBase)
    .map((p, i) => ({
      label: p.ticker,
      value: p.valueBase,
      color: i < INSIGHT_PALETTE.length ? INSIGHT_PALETTE[i] : '#9ca3af',
    }));

  const views = [
    { key: 'ticker',   label: 'Ticker'   },
    { key: 'currency', label: 'Currency' },
    { key: 'sector',   label: 'Sector'   },
    { key: 'country',  label: 'Country'  },
  ];

  const needsMeta = view === 'sector' || view === 'country';
  const data = view === 'ticker'   ? tickerData
             : view === 'currency' ? groupBy('ccy')
             : view === 'sector'   ? groupBy('sector')
             :                       groupBy('country');

  return (
    <div className="bg-white border-b border-gray-100 px-4 pt-4 pb-5">
      {/* View toggle */}
      <div className="flex items-center gap-2 mb-4 flex-wrap">
        <span className="text-[10px] text-gray-400 uppercase tracking-widest mr-1">Composition</span>
        {views.map(v => (
          <button key={v.key}
            onClick={() => setView(v.key)}
            className={`text-[12px] px-3 py-1 rounded-full border transition-colors ${
              view === v.key
                ? 'bg-gray-900 text-white border-gray-900'
                : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400 hover:text-gray-700'
            }`}>
            {v.label}
          </button>
        ))}
        {needsMeta && metaLoading > 0 && (
          <span className="text-[11px] text-gray-400 ml-1 flex items-center gap-1">
            <span className="inline-block spin">↻</span>
            fetching metadata ({metaLoading} left)…
          </span>
        )}
      </div>

      {data.length === 0 ? (
        <div className="text-[12px] text-gray-400 text-center py-6">
          {needsMeta && metaLoading > 0 ? 'Loading…' : 'No data'}
        </div>
      ) : (
        <PieChart data={data} />
      )}
    </div>
  );
}

// ─── App ───────────────────────────────────────────────────────────────────
function App() {
  const [prices, setPrices]           = useState({});
  const [fx, setFx]                   = useState(CACHED_FX);
  const [loading, setLoading]         = useState(true);
  const [refreshing, setRefreshing]   = useState(false);
  const [isLive, setIsLive]           = useState(false);
  const [lastUpdated, setLastUpdated] = useState(null);
  const [sortBy, setSortBy]           = useState('value');
  const [sortDir, setSortDir]         = useState('desc');
  const [notice, setNotice]           = useState(null);
  const [selectedTicker, setSelectedTicker] = useState(null);
  const [showClosed,    setShowClosed]    = useState(false);
  const [showAddModal,  setShowAddModal]  = useState(false);
  const [showInsights,  setShowInsights]  = useState(false);
  const [metaLoading,   setMetaLoading]   = useState(0);
  const metaAttempted   = React.useRef(new Set()); // IDs attempted this session

  // ── Portfolios state ──
  const [portfolios,    setPortfolios]    = useState([]);
  const [portfolioId,   setPortfolioId]   = useState(null); // currently selected portfolio id
  const [baseCcy,       setBaseCcy]       = useState('DKK');
  const [pfListLoaded,  setPfListLoaded]  = useState(false);

  // ── Auth state ──
  const [user,         setUser]         = useState(null);   // null = not logged in
  const [authChecked,  setAuthChecked]  = useState(false);  // prevents flash
  const [setupNeeded,  setSetupNeeded]  = useState(false);
  const [showLogin,    setShowLogin]    = useState(false);
  const [pendingAction, setPendingAction] = useState(null); // action to run after login

  // ── Portfolio from DB ─────────────────────────────────────────────────
  const portfolioRef = React.useRef(SEED_PORTFOLIO); // used inside fetchPrices
  const [portfolio,       setPortfolio]       = useState([]);
  const [portfolioLoaded, setPortfolioLoaded] = useState(false);

  useEffect(() => {
    if (!portfolioId) return;
    fetch(`${PORTFOLIO_API}?portfolio_id=${portfolioId}`)
      .then(r => r.ok ? r.json() : [])
      .then(async rows => {
        if (rows.length === 0) {
          // First ever load — seed from SEED_PORTFOLIO
          const res = await fetch(`${PORTFOLIO_API}?batch=1&portfolio_id=${portfolioId}`, {
            method: 'POST', headers: authHeaders(),
            body: JSON.stringify(SEED_PORTFOLIO),
          });
          if (res.ok) {
            const seeded = await res.json();
            const pf = seeded.map(normalizePfRow);
            portfolioRef.current = pf;
            setPortfolio(pf);
          } else {
            portfolioRef.current = SEED_PORTFOLIO;
            setPortfolio(SEED_PORTFOLIO);
          }
        } else {
          const pf = rows.map(normalizePfRow);
          portfolioRef.current = pf;
          setPortfolio(pf);
        }
        setPortfolioLoaded(true);
      })
      .catch(() => {
        portfolioRef.current = SEED_PORTFOLIO;
        setPortfolio(SEED_PORTFOLIO);
        setPortfolioLoaded(true);
      });
  }, [portfolioId]);

  // Keep ref in sync whenever portfolio state changes
  useEffect(() => { if (portfolio.length > 0) portfolioRef.current = portfolio; }, [portfolio]);

  // ── Fetch + cache sector/country metadata for holdings that lack it ──
  useEffect(() => {
    if (!portfolioLoaded || portfolio.length === 0) return;
    // Include 'Unknown' so holdings enriched with the old broken proxy get re-enriched.
    // metaAttempted ref prevents infinite retries for tickers that are genuinely unknown.
    const missing = portfolio.filter(p =>
      p.id && (p.sector == null || p.sector === 'Unknown') && !metaAttempted.current.has(p.id)
    );
    if (missing.length === 0) return;

    // Mark all as attempted before any async work to avoid duplicate fetches
    missing.forEach(h => metaAttempted.current.add(h.id));

    let cancelled = false;
    setMetaLoading(missing.length);

    missing.forEach(async (holding) => {
      try {
        const c = new AbortController();
        const t = setTimeout(() => c.abort(), 10000);
        let metaJson = null;
        try {
          const res = await fetch(`${META_API}?ticker=${encodeURIComponent(holding.yhTicker)}`, { signal: c.signal });
          clearTimeout(t);
          if (res.ok) metaJson = await res.json();
        } catch (e) { clearTimeout(t); }
        if (cancelled) return;
        const sector  = metaJson?.sector  || 'Unknown';
        const country = metaJson?.country || 'Unknown';
        setPortfolio(prev => prev.map(p => p.id === holding.id ? { ...p, sector, country } : p));
        // Persist to DB so subsequent loads skip this fetch
        fetch(`${PORTFOLIO_API}?_method=PUT&id=${holding.id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ sector, country }),
        }).catch(() => {});
      } catch (e) {
        if (!cancelled) {
          setPortfolio(prev => prev.map(p => p.id === holding.id ? { ...p, sector: 'Unknown', country: 'Unknown' } : p));
          // Persist so we don't retry on every page load
          fetch(`${PORTFOLIO_API}?_method=PUT&id=${holding.id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({ sector: 'Unknown', country: 'Unknown' }),
          }).catch(() => {});
        }
      } finally {
        if (!cancelled) setMetaLoading(prev => Math.max(0, prev - 1));
      }
    });
    return () => { cancelled = true; setMetaLoading(0); };
  }, [portfolioLoaded, portfolioId]);

  // ── Load portfolio list on mount (public — no auth required) ──
  useEffect(() => {
    fetch(PORTFOLIOS_API)
      .then(r => r.ok ? r.json() : [])
      .then(pfs => {
        if (pfs.length > 0) {
          setPortfolios(pfs);
          const saved = parseInt(localStorage.getItem('selected_portfolio_id'));
          const found = pfs.find(p => p.id === saved);
          const activePf = found || pfs[0];
          setPortfolioId(activePf.id);
          setBaseCcy(activePf.base_currency || 'DKK');
        }
        setPfListLoaded(true);
      })
      .catch(() => setPfListLoaded(true));
  }, []);

  // ── Auth: check setup + restore session on mount ──
  useEffect(() => {
    const token = localStorage.getItem('auth_token');
    // Always check setup status first
    fetch(`${AUTH_API}?setup_check=1`)
      .then(r => r.ok ? r.json() : { setupNeeded: false })
      .then(data => {
        if (data.setupNeeded) {
          setSetupNeeded(true);
          setAuthChecked(true);
          return;
        }
        // Restore session if token exists
        if (token) {
          return fetch(AUTH_API, { headers: { Authorization: `Bearer ${token}` } })
            .then(r => { if (!r.ok) { localStorage.removeItem('auth_token'); return null; } return r.json(); })
            .then(u => { if (u) setUser(u); })
            .finally(() => setAuthChecked(true));
        }
        setAuthChecked(true);
      })
      .catch(() => setAuthChecked(true));
  }, []);

  const handlePortfolioAction = useCallback((pf) => {
    if (pf._deleted) {
      setPortfolios(prev => {
        const next = prev.filter(p => p.id !== pf.id);
        if (portfolioId === pf.id && next.length > 0) switchPortfolio(next[0].id, next[0].base_currency);
        return next;
      });
    } else if (pf._rename) {
      setPortfolios(prev => prev.map(p => p.id === pf.id ? { ...p, name: pf.name } : p));
    } else {
      // new portfolio created
      setPortfolios(prev => [...prev, pf]);
      switchPortfolio(pf.id, pf.base_currency);
    }
  }, [portfolioId]);

  const switchPortfolio = useCallback((id, ccy) => {
    setPortfolioId(id);
    if (ccy) setBaseCcy(ccy);
    localStorage.setItem('selected_portfolio_id', id);
    // Reset all portfolio-scoped state so it reloads for the new portfolio
    setPortfolio([]);
    setPortfolioLoaded(false);
    setAllTxns({});
    setTxnsLoaded(false);
    setPrices({});
    setIsLive(false);
    setSelectedTicker(null);
    portfolioRef.current = SEED_PORTFOLIO;
  }, []);

  const requireLogin = useCallback((action) => {
    if (user) { action(); }
    else { setPendingAction(() => action); setShowLogin(true); }
  }, [user]);

  const handleLogin = useCallback((data) => {
    localStorage.setItem('auth_token', data.token);
    setUser({ id: data.id, name: data.name, email: data.email });
    setShowLogin(false);
    setPendingAction(prev => { if (prev) { prev(); return null; } return null; });
  }, []);

  const handleSetupComplete = useCallback((data) => {
    localStorage.setItem('auth_token', data.token);
    setUser({ id: data.id, name: data.name, email: data.email });
    setSetupNeeded(false);
  }, []);

  const handleCcyChange = useCallback(async (pfId, ccy) => {
    await fetch(`${PORTFOLIOS_API}?_method=PUT&id=${pfId}`, {
      method: 'POST', headers: authHeaders(),
      body: JSON.stringify({ base_currency: ccy }),
    });
    setBaseCcy(ccy);
    setPortfolios(prev => prev.map(p => p.id === pfId ? { ...p, base_currency: ccy } : p));
  }, []);

  const handleLogout = useCallback(async () => {
    const token = localStorage.getItem('auth_token');
    if (token) {
      fetch(`${AUTH_API}?_method=DELETE`, {
        method: 'POST', headers: { Authorization: `Bearer ${token}` },
      }).catch(() => {});
    }
    localStorage.removeItem('auth_token');
    setUser(null);
  }, []);

  // ── Transactions from DB ──────────────────────────────────────────────
  // allTxns: { [ticker]: [{id, date, type, shares, price, fees, note}, ...] }
  const [allTxns,    setAllTxns]    = useState({});
  const [txnsLoaded, setTxnsLoaded] = useState(false);

  useEffect(() => {
    if (!portfolioId) return;
    fetch(`${TRANSACTIONS_API}?portfolio_id=${portfolioId}`)
      .then(r => r.ok ? r.json() : [])
      .then(async rows => {
        // Group by ticker
        const grouped = {};
        rows.forEach(t => { (grouped[t.ticker] = grouped[t.ticker] || []).push(t); });

        if (rows.length === 0) {
          // First ever load — seed from SEED_TRANSACTIONS
          const flat = [];
          Object.entries(SEED_TRANSACTIONS).forEach(([ticker, txns]) =>
            txns.forEach(t => flat.push({ ...t, ticker }))
          );
          if (flat.length > 0) {
            const res = await fetch(`${TRANSACTIONS_API}?batch=1`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(flat),
            });
            if (res.ok) {
              const seeded = await fetch(TRANSACTIONS_API).then(r => r.json());
              seeded.forEach(t => { (grouped[t.ticker] = grouped[t.ticker] || []).push(t); });
            }
          }
        }
        setAllTxns(grouped);
        setTxnsLoaded(true);
      })
      .catch(() => {
        const grouped = {};
        Object.entries(SEED_TRANSACTIONS).forEach(([ticker, txns]) => {
          grouped[ticker] = txns.map((t, i) => ({ ...t, ticker, id: -(i+1) }));
        });
        setAllTxns(grouped);
        setTxnsLoaded(true);
      });
  }, [portfolioId]);

  // Called by DetailPage when it adds/edits/deletes a transaction
  const handleTxnsChanged = useCallback((ticker, updatedTxns) => {
    setAllTxns(prev => ({ ...prev, [ticker]: updatedTxns }));
  }, []);

  // Called when a holding is removed from DetailPage
  const handleRemoveHolding = useCallback((ticker) => {
    setPortfolio(prev => {
      const next = prev.filter(p => p.ticker !== ticker);
      portfolioRef.current = next;
      return next;
    });
    setAllTxns(prev => {
      const next = { ...prev };
      delete next[ticker];
      return next;
    });
    setSelectedTicker(null);
  }, []);

  // Called when a new holding is added via AddHoldingModal
  const handlePortfolioChanged = useCallback((newPfItem, firstTxn) => {
    setPortfolio(prev => {
      const next = [...prev, newPfItem];
      portfolioRef.current = next;
      return next;
    });
    if (firstTxn) {
      setAllTxns(prev => ({ ...prev, [newPfItem.ticker]: [firstTxn] }));
    }
    // Re-fetch prices so the new ticker appears live
    setTimeout(() => fetchPrices(true), 200);
  }, []);

  const fetchPrices = useCallback(async (silent=false) => {
    const pf = portfolioRef.current;
    if (!silent) setLoading(true);
    setRefreshing(true);

    const stockSyms = pf.map(p => p.yhTicker);
    const fxSyms    = ['USDDKK=X','EURDKK=X','CADDKK=X'];
    const symbols   = [...stockSyms, ...fxSyms].join(',');
    const workerUrl = `https://yf-proxy.labanos.workers.dev/?symbols=${symbols}`;
    const apiUrl    = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${symbols}&fields=regularMarketPrice,regularMarketChangePercent`;

    // Try worker first (Cloudflare proxy bypasses CORS/auth), then fall back
    const sources = [
      workerUrl,                                                                  // Cloudflare Worker (primary)
      apiUrl,                                                                     // direct (works in some browsers)
      `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`,                     // proxy 1
    ];

    let rows = null;
    for (const url of sources) {
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 8000);
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeout);
        if (!res.ok) continue;
        const json = await res.json();
        const result = json?.quoteResponse?.result || [];
        if (result.length > 0) { rows = result; break; }
      } catch (e) { continue; }
    }

    if (rows) {
      const newPrices = {};
      const newFx = { ...CACHED_FX };
      rows.forEach(q => {
        const price  = q.regularMarketPrice;
        const chgPct = (q.regularMarketChangePercent ?? 0) / 100;
        if      (q.symbol === 'USDDKK=X') newFx.USD = price;
        else if (q.symbol === 'EURDKK=X') newFx.EUR = price;
        else if (q.symbol === 'CADDKK=X') newFx.CAD = price;
        else newPrices[q.symbol] = { price, chgPct };
      });
      setPrices(newPrices);
      setFx(newFx);
      setIsLive(true);
      setLastUpdated(new Date());           // actual time of successful fetch
    } else {
      setIsLive(false);
      setLastUpdated(CACHED_AS_OF);         // time the cached prices were recorded
      if (Object.keys(prices).length === 0) {
        const cached = {};
        pf.forEach(p => { cached[p.yhTicker] = { price: p.cachedPrice || 0, chgPct: p.cachedChg || 0 }; });
        setPrices(cached);
        setFx(CACHED_FX);
      }
    }
    setLoading(false);
    setRefreshing(false);
  }, []);

  // Trigger price fetch once portfolio is loaded, then poll every 5 min
  useEffect(() => {
    if (!portfolioLoaded) return;
    fetchPrices();
    const iv = setInterval(() => fetchPrices(true), 5 * 60 * 1000);
    return () => clearInterval(iv);
  }, [portfolioLoaded]);

  // Enrich each position — shares/avgCost derived from DB transactions
  const enriched = portfolio.map(p => {
    const { shares, avgCost } = computePosition(allTxns[p.ticker] || []);
    const pd         = prices[p.yhTicker] || { price: p.cachedPrice, chgPct: p.cachedChg };
    const fxToBase   = (fx[p.ccy] || 1) / (fx[baseCcy] || 1);
    const costBase   = shares * avgCost * fxToBase;
    const valueBase  = shares * pd.price * fxToBase;
    const glBase     = valueBase - costBase;
    const glPct      = costBase > 0 ? glBase / costBase : 0;
    const prevPrice  = pd.chgPct !== -1 ? pd.price / (1 + pd.chgPct) : pd.price;
    const todayBase  = shares * (pd.price - prevPrice) * fxToBase;
    return { ...p, shares, avgCost, price: pd.price, chgPct: pd.chgPct, fxToBase, costBase, valueBase, glBase, glPct, todayBase };
  });

  const totalValue  = enriched.reduce((s,p) => s + p.valueBase, 0);
  const totalCost   = enriched.reduce((s,p) => s + p.costBase, 0);
  const totalGL     = totalValue - totalCost;
  const totalGLPct  = totalCost > 0 ? totalGL / totalCost : 0;
  const todayTotal  = enriched.reduce((s,p) => s + p.todayBase, 0);
  const prevTotal   = totalValue - todayTotal;
  const todayPct    = prevTotal > 0 ? todayTotal / prevTotal : 0;

  const withWeight = enriched.map(p => ({ ...p, weight: totalValue > 0 ? p.valueBase / totalValue : 0 }));

  // ── Split active vs closed positions ──
  const activePositions = withWeight.filter(p => p.shares > 0);
  const closedPositions = withWeight.filter(p => p.shares === 0);

  // ── Detail page navigation (works for both active and closed positions) ──
  if (selectedTicker) {
    const pos = withWeight.find(p => p.ticker === selectedTicker);
    if (pos) return (
      <DetailPage
        position={pos}
        initialTxns={(allTxns[selectedTicker] || []).slice().sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id)}
        onBack={() => setSelectedTicker(null)}
        onTxnsChanged={handleTxnsChanged}
        onRemoveHolding={handleRemoveHolding}
        user={user}
        onRequireLogin={requireLogin}
        portfolioId={portfolioId}
        isLive={isLive}
        lastUpdated={lastUpdated}
        baseCcy={baseCcy}
      />
    );
  }

  const sortFn = (a, b) => {
    let diff = 0;
    if (sortBy === 'value') diff = b.valueBase - a.valueBase;
    if (sortBy === 'today') diff = b.chgPct - a.chgPct;
    if (sortBy === 'gl')    diff = b.glPct - a.glPct;
    return sortDir === 'asc' ? -diff : diff;
  };
  const sortedActive = [...activePositions].sort(sortFn);
  const sortedClosed = [...closedPositions].sort(sortFn);

  const handleSort = (col) => {
    if (col === sortBy) {
      setSortDir(d => d === 'desc' ? 'asc' : 'desc');
    } else {
      setSortBy(col);
      setSortDir('desc');
    }
  };

  const SortBtn = ({ col, label }) => (
    <th
      className={`px-3 py-2 text-right cursor-pointer select-none text-xs ${sortBy===col ? 'text-gray-700 font-semibold' : 'text-gray-400 font-normal'}`}
      onClick={() => handleSort(col)}
    >
      {label}{sortBy===col ? (sortDir === 'desc' ? ' ↓' : ' ↑') : ''}
    </th>
  );

  const priceStr = (p) => {
    const v = p.price;
    if (v == null) return '–';
    if (v >= 1000) return v.toLocaleString('da-DK', {maximumFractionDigits:0});
    if (v >= 10)   return v.toLocaleString('da-DK', {minimumFractionDigits:2, maximumFractionDigits:2});
    return v.toLocaleString('da-DK', {minimumFractionDigits:2, maximumFractionDigits:2});
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-10">

      {/* ── Header ── */}
      <div className="bg-gray-900 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-20">
        <div className="flex items-center gap-2">
          {pfListLoaded && portfolios.length > 0 ? (
            <PortfolioSwitcher
              portfolios={portfolios}
              portfolioId={portfolioId}
              onSwitch={switchPortfolio}
              onCreateNew={handlePortfolioAction}
              onCcyChange={handleCcyChange}
              user={user}
            />
          ) : (
            <span className="font-semibold text-[15px]">Portfolio</span>
          )}
          <span className={`text-[10px] px-1.5 py-0.5 rounded-full font-medium ${isLive ? 'bg-emerald-500/20 text-emerald-400' : 'bg-gray-700 text-gray-400'}`}>
            {isLive ? '● live' : '○ cached'}
          </span>
        </div>
        <div className="flex items-center gap-2">
          {user ? (
            <div className="flex items-center gap-2">
              <span className="text-[11px] text-gray-400 hidden sm:block">{user.name}</span>
              <button onClick={handleLogout}
                className="text-[11px] text-gray-400 hover:text-white transition-colors px-2 py-1 rounded-lg border border-gray-700 hover:border-gray-500">
                Sign out
              </button>
            </div>
          ) : authChecked ? (
            <button onClick={() => setShowLogin(true)}
              className="text-xs bg-gray-700 hover:bg-gray-600 transition-colors px-3 py-1.5 rounded-full font-medium">
              Sign in
            </button>
          ) : null}
          {user && (
          <button
            onClick={() => setShowAddModal(true)}
            title="Add new holding"
            className="text-xs bg-blue-600 hover:bg-blue-500 active:bg-blue-700 transition-colors px-3 py-1.5 rounded-full font-semibold"
          >
            + New
          </button>
          )}
          <button
            onClick={() => fetchPrices()}
            className="text-xs bg-gray-700 hover:bg-gray-600 active:bg-gray-500 transition-colors px-3 py-1.5 rounded-full"
          >
            {refreshing ? <span className="inline-block spin">↻</span> : '↻'}
          </button>
        </div>
      </div>

      {/* ── Add Holding Modal ── */}
      {showAddModal && (
        <AddHoldingModal
          onClose={() => setShowAddModal(false)}
          onAdded={handlePortfolioChanged}
          user={user}
          portfolioId={portfolioId}
        />
      )}

      {/* ── Login Modal ── */}
      {showLogin && (
        <LoginModal onLogin={handleLogin} onClose={() => { setShowLogin(false); setPendingAction(null); }} />
      )}

      {/* ── First-time Setup Modal ── */}
      {setupNeeded && (
        <SetupModal onComplete={handleSetupComplete} />
      )}

      {/* ── Price timestamp bar ── */}
      {lastUpdated && (
        <div className={`px-4 py-1.5 flex items-center justify-between text-[11px] border-b ${isLive ? 'bg-emerald-50 border-emerald-100 text-emerald-700' : 'bg-amber-50 border-amber-200 text-amber-700'}`}>
          <span>
            {isLive ? '● Prices as of' : '⚠ Cached prices from'}{' '}
            <span className="font-semibold mono">
              {lastUpdated.toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
            </span>
            {' '}
            <span className="opacity-70">
              {lastUpdated.toLocaleDateString('da-DK', {day:'2-digit', month:'2-digit', year:'numeric'})}
            </span>
          </span>
          {!isLive && <span className="font-medium">Live data unavailable</span>}
        </div>
      )}

      {loading ? (
        <div className="flex flex-col items-center justify-center h-64 gap-2 text-gray-400">
          <span className="text-2xl spin">↻</span>
          <span className="text-sm">Fetching prices…</span>
        </div>
      ) : (
        <>
          {/* ── Summary row ── */}
          <div className="grid bg-white border-b border-gray-100" style={{ gridTemplateColumns: '1fr 1fr 1fr auto' }}>
            <div className="px-4 py-3 border-r border-gray-100">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Portfolio</div>
              <div className="font-bold text-gray-900 mono text-base leading-tight">
                {n(totalValue, 0)}<span className="text-xs font-normal text-gray-400"> {baseCcy}</span>
              </div>
            </div>
            <div className="px-4 py-3 border-r border-gray-100">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Today</div>
              <div className={`font-bold mono text-base leading-tight ${clr(todayTotal)}`}>{pct(todayPct)}</div>
              <div className={`text-[11px] mono ${clr(todayTotal)}`}>{signed(todayTotal,0)} {baseCcy}</div>
            </div>
            <div className="px-4 py-3 border-r border-gray-100">
              <div className="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Total G/L</div>
              <div className={`font-bold mono text-base leading-tight ${clr(totalGL)}`}>{pct(totalGLPct)}</div>
              <div className={`text-[11px] mono ${clr(totalGL)}`}>{signed(totalGL,0)} {baseCcy}</div>
            </div>
            <button
              onClick={() => setShowInsights(v => !v)}
              title="Portfolio insights"
              className={`px-4 flex flex-col items-center justify-center gap-0.5 transition-colors border-l-0 ${
                showInsights ? 'bg-gray-900 text-white' : 'text-gray-400 hover:text-gray-700 hover:bg-gray-50'
              }`}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>
              </svg>
              <span className="text-[9px] uppercase tracking-wide font-medium">Insights</span>
            </button>
          </div>

          {/* ── Insights panel ── */}
          {showInsights && (
            <InsightsPanel
              positions={withWeight}
              baseCcy={baseCcy}
              metaLoading={metaLoading}
            />
          )}

          {/* ── Table ── */}
          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr className="bg-gray-100 border-b border-gray-200">
                  <th className="px-4 py-2 text-left text-xs text-gray-400 font-normal">Stock</th>
                  <SortBtn col="value" label="Value" />
                  <SortBtn col="today" label="Today" />
                  <SortBtn col="gl"    label="G/L" />
                  <th className="px-3 py-2 text-right text-xs text-gray-400 font-normal">Wt</th>
                </tr>
              </thead>
              <tbody>
                {/* Active positions */}
                {sortedActive.map((p, i) => (
                  <tr key={p.ticker} onClick={() => setSelectedTicker(p.ticker)} className={`border-b border-gray-100 cursor-pointer transition-colors ${i%2===0 ? 'bg-white hover:bg-blue-50' : 'bg-gray-50/60 hover:bg-blue-50'}`}>
                    <td className="px-4 py-2.5 min-w-[110px]">
                      <div className="font-semibold text-gray-900 text-[13px]">{p.ticker}</div>
                      <div className="text-[11px] text-gray-400 truncate max-w-[110px]">{p.company}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right">
                      <div className="font-medium text-gray-800 mono text-[13px]">{n(p.valueBase,0)}</div>
                      <div className="text-[11px] text-gray-400 mono">{priceStr(p)} <span className="text-[10px]">{p.ccy}</span></div>
                    </td>
                    <td className={`px-3 py-2.5 text-right mono ${clr(p.chgPct)}`}>
                      <div className="text-[13px] font-semibold">{pct(p.chgPct)}</div>
                      <div className="text-[11px] opacity-80">{signed(p.todayBase,0)}</div>
                    </td>
                    <td className={`px-3 py-2.5 text-right mono ${clr(p.glPct)}`}>
                      <div className="text-[13px] font-semibold">{pct(p.glPct)}</div>
                      <div className="text-[11px] opacity-80">{signed(p.glBase,0)}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right text-[11px] text-gray-400 mono">
                      {n(p.weight*100,1)}%
                    </td>
                  </tr>
                ))}

                {/* Closed positions toggle row */}
                {closedPositions.length > 0 && (
                  <tr className="border-t border-gray-200 bg-gray-50/50">
                    <td colSpan={5}>
                      <button
                        onClick={() => setShowClosed(s => !s)}
                        className="w-full px-4 py-2.5 text-left text-[12px] text-gray-400 hover:text-gray-600 flex items-center gap-1.5"
                      >
                        <span className="text-[10px]">{showClosed ? '▾' : '▸'}</span>
                        {showClosed ? 'Hide' : 'Show'} {closedPositions.length} closed position{closedPositions.length !== 1 ? 's' : ''}
                      </button>
                    </td>
                  </tr>
                )}

                {/* Closed positions rows */}
                {showClosed && sortedClosed.map((p) => (
                  <tr key={p.ticker} onClick={() => setSelectedTicker(p.ticker)}
                    className="border-b border-gray-50 cursor-pointer bg-gray-50/30 hover:bg-blue-50 opacity-50">
                    <td className="px-4 py-2.5 min-w-[110px]">
                      <div className="flex items-center gap-1.5">
                        <span className="font-semibold text-gray-500 text-[13px]">{p.ticker}</span>
                        <span className="text-[9px] text-gray-400 bg-gray-100 px-1 py-0.5 rounded uppercase tracking-wide">closed</span>
                      </div>
                      <div className="text-[11px] text-gray-400 truncate max-w-[110px]">{p.company}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right">
                      <div className="text-[11px] text-gray-400 italic">—</div>
                      <div className="text-[11px] text-gray-300 mono">{priceStr(p)} <span className="text-[10px]">{p.ccy}</span></div>
                    </td>
                    <td className="px-3 py-2.5 text-right mono text-gray-300">
                      <div className="text-[13px]">{pct(p.chgPct)}</div>
                    </td>
                    <td className="px-3 py-2.5 text-right mono text-gray-300 text-[13px]">—</td>
                    <td className="px-3 py-2.5 text-right text-[11px] text-gray-300 mono">—</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* ── Footer: FX rates ── */}
          <div className="px-4 py-3 text-[11px] text-gray-400 text-center border-t border-gray-100 bg-white mt-0">
            FX → {baseCcy}: &nbsp;
            {baseCcy !== 'USD' && <>USD {(fx.USD/(fx[baseCcy]||1)).toFixed(4)}&nbsp;·&nbsp;</>}
            {baseCcy !== 'EUR' && <>EUR {(fx.EUR/(fx[baseCcy]||1)).toFixed(4)}&nbsp;·&nbsp;</>}
            {baseCcy !== 'DKK' && <>DKK {(1/(fx[baseCcy]||1)).toFixed(4)}&nbsp;·&nbsp;</>}
            {baseCcy !== 'CAD' && <>CAD {(fx.CAD/(fx[baseCcy]||1)).toFixed(4)}</>}
            {!isLive && <span className="ml-2 text-amber-500">cached</span>}
          </div>
        </>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
