name: Deploy PHP to labanos.dk

on:
  push:
    branches: [master]
    paths:
      - 'php/notes.php'
      - 'php/transactions.php'
      - 'php/portfolio.php'
      - 'php/portfolio_history.php'
      - 'php/db_migrate.php'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject DB credentials
        run: |
          FILES="php/notes.php php/transactions.php php/portfolio.php php/portfolio_history.php php/db_migrate.php"
          sed -i "s|%%DB_HOST%%|${{ secrets.DB_HOST }}|g" $FILES
          sed -i "s|%%DB_NAME%%|${{ secrets.DB_NAME }}|g" $FILES
          sed -i "s|%%DB_USER%%|${{ secrets.DB_USER }}|g" $FILES
          sed -i "s|%%DB_PASS%%|${{ secrets.DB_PASS }}|g" $FILES

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy via SFTP
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" sftp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -P ${{ secrets.SFTP_PORT }} \
            "${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}" <<'SFTP'
          put php/notes.php notes.php
          put php/transactions.php transactions.php
          put php/portfolio.php portfolio.php
          put php/portfolio_history.php portfolio_history.php
          put php/db_migrate.php db_migrate.php
          SFTP

      - name: Done
        run: echo "âœ… PHP files deployed to labanos.dk"
