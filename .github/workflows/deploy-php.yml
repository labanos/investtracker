name: Deploy PHP to labanos.dk

on:
  push:
    branches: [master]
    paths:
      - 'php/notes.php'
      - 'php/transactions.php'
      - 'php/portfolio.php'
      - 'php/portfolios.php'
      - 'php/auth.php'
      - 'php/auth_check.php'
      - 'php/db_migrate.php'
      - 'php/.htaccess'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Inject DB credentials
        run: |
          sed -i "s|%%DB_HOST%%|${{ secrets.DB_HOST }}|g" php/notes.php php/transactions.php php/portfolio.php php/portfolios.php php/auth.php
          sed -i "s|%%DB_NAME%%|${{ secrets.DB_NAME }}|g" php/notes.php php/transactions.php php/portfolio.php php/portfolios.php php/auth.php
          sed -i "s|%%DB_USER%%|${{ secrets.DB_USER }}|g" php/notes.php php/transactions.php php/portfolio.php php/portfolios.php php/auth.php
          sed -i "s|%%DB_PASS%%|${{ secrets.DB_PASS }}|g" php/notes.php php/transactions.php php/portfolio.php php/portfolios.php php/auth.php

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy via SFTP
        run: |
          sshpass -p "${{ secrets.SFTP_PASS }}" sftp \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -P ${{ secrets.SFTP_PORT }} \
            "${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }}" <<'SFTP'
          put php/notes.php notes.php
          put php/transactions.php transactions.php
          put php/portfolio.php portfolio.php
          put php/portfolios.php portfolios.php
          put php/auth.php auth.php
          put php/auth_check.php auth_check.php
          put php/db_migrate.php db_migrate.php
          put php/.htaccess .htaccess
          SFTP

      - name: Done
        run: echo "âœ… All PHP files deployed to labanos.dk"
